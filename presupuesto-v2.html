<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Presupuesto Interno - FassaBortolo Caribe</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; line-height: 1.6; }
        .header { background: white; padding: 1rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .logo span { color: #e74c3c; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .budget-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; }
        .budget-header h1 { font-size: 2.2rem; margin-bottom: 1rem; }
        .project-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .info-card { background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px; }
        .budget-table { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 1rem; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6; }
        td { padding: 1rem; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f8f9fa; }
        .system-name { font-weight: 600; color: #2c3e50; }
        .qty-input { width: 80px; padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 4px; text-align: center; }
        .total-row { background: #e74c3c; color: white; font-size: 1.3rem; font-weight: bold; }
        .actions-section { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; margin: 0.5rem; }
        .btn-success { background: #28a745; color: white; }
        .btn-primary { background: #2c3e50; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .materials-breakdown { background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-top: 1rem; }
        .materials-breakdown h3 { color: #2c3e50; margin-bottom: 1rem; }
        .price-summary { background: white; padding: 1.5rem; border-radius: 10px; margin-top: 1rem; border-left: 4px solid #28a745; }
        .price-summary h3 { color: #2c3e50; margin-bottom: 1rem; }
        .price-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #dee2e6; }
        .price-row.total { font-weight: bold; font-size: 1.2rem; background: #e74c3c; color: white; padding: 1rem; margin-top: 1rem; border-radius: 6px; }
        .disclaimer-section { background: rgba(231, 76, 60, 0.1); border-left: 4px solid #e74c3c; padding: 1.5rem; margin: 2rem 0; border-radius: 8px; color: #2c3e50; }
        .disclaimer-section strong { color: #e74c3c; }
        .validation-alert { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .validation-alert.error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .validation-alert.success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        @media (max-width: 768px) { .project-info { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">Fassa<span>Bortolo</span> Caribe</div>
            <div style="font-weight:bold; color:#e74c3c;">üõ†Ô∏è MATERIALES POR SISTEMA</div>
        </nav>
    </header>

    <main class="main-container">
        <div class="budget-header">
            <h1><i class="fas fa-calculator"></i> Generador de Presupuesto de Materiales</h1>
            <div class="project-info">
                <div class="info-card">
                    <strong>Proyecto:</strong><br>
                    <input type="text" id="projectName" placeholder="Ej: Larimar Prime T4" style="width:100%; padding:0.5rem; margin-top:0.5rem; border-radius:4px; border:none;">
                </div>
                <div class="info-card">
                    <strong>Total m¬≤:</strong><br>
                    <span id="totalM2" style="font-size:1.5rem;">0</span> m¬≤
                </div>
                <div class="info-card">
                    <strong>Sistemas:</strong><br>
                    <span id="totalSistemas" style="font-size:1.5rem;">0</span> sistemas
                </div>
                <div class="info-card">
                    <strong>Estado:</strong><br>
                    <span style="color:#28a745;">Interno</span>
                </div>
            </div>
        </div>

        <div class="budget-table">
            <table>
                <thead>
                    <tr>
                        <th>Sistema</th>
                        <th>C√≥digo</th>
                        <th>m¬≤ Proyecto</th>
                        <th>Precio/m¬≤</th>
                        <th>Subtotal</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody"></tbody>
                <tfoot id="budgetTableFooter" style="display:none;">
                    <tr class="total-row">
                        <td colspan="4" style="text-align:right;">TOTAL PRESUPUESTO:</td>
                        <td id="totalPresupuesto" style="text-align:right;">$0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="materials-breakdown" id="materialsBreakdown" style="display:none;">
            <h3><i class="fas fa-cogs"></i> Desglose Total de Materiales</h3>
            <table id="materialsTotalTable" style="width:100%; border-collapse: collapse; margin-top:1rem;">
                <thead>
                    <tr style="background:#dee2e6;">
                        <th style="padding:1rem; text-align:left;">Material</th>
                        <th style="padding:1rem; text-align:center;">Cantidad</th>
                        <th style="padding:1rem; text-align:center;">Unidad</th>
                        <th style="padding:1rem; text-align:right;">Precio Unit.</th>
                        <th style="padding:1rem; text-align:right;">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="materialsTotalBody"></tbody>
                <tfoot>
                    <tr style="background:#e74c3c; color:white; font-weight:bold;">
                        <td colspan="4" style="padding:1rem; text-align:right;">TOTAL MATERIALES:</td>
                        <td id="totalMaterialesPrecio" style="padding:1rem; text-align:right;">$0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="price-summary" id="priceSummary" style="display:none;">
            <h3><i class="fas fa-chart-line"></i> Resumen de Costos</h3>
            <div class="price-row">
                <span>Subtotal Materiales:</span>
                <span id="subtotalMateriales">$0.00</span>
            </div>
            <div class="price-row">
                <span>Mermas (8%):</span>
                <span id="mermas">$0.00</span>
            </div>
            <div class="price-row">
                <span>IVA (21%):</span>
                <span id="iva">$0.00</span>
            </div>
            <div class="price-row total">
                <span>TOTAL PRESUPUESTO:</span>
                <span id="totalFinal">$0.00</span>
            </div>
        </div>

        <div class="actions-section">
            <button class="btn btn-success" onclick="exportMaterialsList()" disabled style="opacity:0.5;">
                <i class="fas fa-file-excel"></i> Exportar Lista de Materiales (Excel)
            </button>
            <button class="btn btn-primary" onclick="exportBudgetPDF()" disabled style="opacity:0.5;">
                <i class="fas fa-file-pdf"></i> PDF Presupuesto Interno
            </button>
            <button class="btn btn-danger" onclick="clearBudget()">
                <i class="fas fa-trash"></i> Vaciar Presupuesto
            </button>
            <a class='btn btn-primary' href='/tabiques'>
                <i class="fas fa-arrow-left"></i> Volver a Sistemas
            </a>
        </div>

        <!-- DISCLAIMER LEGAL AGREGADO -->
        <div style="background: rgba(231, 76, 60, 0.1); border-left: 4px solid #e74c3c; padding: 1.5rem; margin: 2rem 0; border-radius: 8px; color: #2c3e50;">
            <h3 style="color: #e74c3c; margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Nota Legal y T√©cnica</h3>
            <p><strong>‚ö†Ô∏è IMPORTANTE:</strong> Esta herramienta es para uso interno de FassaBortolo Caribe.</p>
            <ul style="margin-top: 1rem; padding-left: 2rem;">
                <li>Los valores de resistencia al fuego (EI) mencionados son referenciales y deben ser validados t√©cnicamente para cada proyecto espec√≠fico.</li>
                <li>Las configuraciones mostradas son compatibles con ensayos realizados, pero NO constituyen certificaci√≥n autom√°tica.</li>
                <li>Los precios son referenciales y pueden variar seg√∫n disponibilidad y zona geogr√°fica.</li>
                <li>Este presupuesto NO es vinculante ni constituye oferta comercial.</li>
            </ul>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 6px;">
                <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: bold;">
                    <input type="checkbox" id="disclaimerCheck" required onchange="toggleExportButtons()">
                    <span>He revisado las especificaciones t√©cnicas, precios y confirmo que los valores EI han sido validados para este proyecto espec√≠fico.</span>
                </label>
            </div>
        </div>
    </main>

    <script>
        // DATOS COMPLETOS DE TODOS LOS SISTEMAS - 20 TOTALES
        const sistemas = [
            // TABIQUES (7 SISTEMAS)
            {
                id: 'T-45-13', nombre: 'Tabique Ligero 91mm (STD 13mm + Z1 45mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 45mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 45mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó25', cantidad: '24', unidad: 'ud' },
                    { material: 'Tornillo metal-metal 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.4', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '1.2', unidad: 'ml' }
                ]
            },
            {
                id: 'T-70-13', nombre: 'Tabique Est√°ndar 116mm (STD 13mm + Z1 70mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 70mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 70mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó25', cantidad: '24', unidad: 'ud' },
                    { material: 'Tornillo metal-metal 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.4', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '1.2', unidad: 'ml' }
                ]
            },
            {
                id: 'T-90-13', nombre: 'Tabique Alto 136mm (STD 13mm + Z1 90mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 90mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 90mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó25', cantidad: '24', unidad: 'ud' },
                    { material: 'Tornillo metal-metal 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.4', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '1.2', unidad: 'ml' }
                ]
            },
            {
                id: 'T-70-15', nombre: 'Tabique Robusto 120mm (STD 15mm + Z1 70mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa STD BA 15mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 70mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 70mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó35', cantidad: '18', unidad: 'ud' },
                    { material: 'Tornillo metal-metal 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.5', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '1.2', unidad: 'ml' }
                ]
            },
            {
                id: 'T-AQ-70-13', nombre: 'Tabique H√∫medo AQUA 116mm (AQUA 13mm + Z1 70mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa AQUA 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 70mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 70mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo Inox 3.5√ó25', cantidad: '24', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.4', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '1.2', unidad: 'ml' },
                    { material: 'Banda estanca 50mm', cantidad: '0.5', unidad: 'ml' }
                ]
            },
            {
                id: 'T-AQ-70-15', nombre: 'Tabique H√∫medo Premium AQUA 120mm (AQUA 15mm + Z1 70mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa AQUA 15mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 70mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 70mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '18', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.5', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '1.2', unidad: 'ml' },
                    { material: 'Banda estanca 50mm', cantidad: '0.5', unidad: 'ml' }
                ]
            },
            {
                id: 'T-EX-70-13', nombre: 'Tabique Exterior Light 96mm (EXTERNA 13mm + Z1 70mm)', categoria: 'tabiques',
                materiales: [
                    { material: 'Placa EXTERNA Light 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 70mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 70mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '20', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSA A 64', cantidad: '0.45', unidad: 'kg' },
                    { material: 'Malla fibra vidrio 100mm', cantidad: '1.0', unidad: 'ml' },
                    { material: 'Banda estanca 70mm', cantidad: '0.6', unidad: 'ml' }
                ]
            },
'''

print("Iniciando archivo presupuesto-v2.html...")
print("‚úÖ Estructura base creada")
            // TRASDOSADOS (6 SISTEMAS)
            {
                id: 'R-HA-13', nombre: 'Trasdosado HA STD 13mm (Omega 17)', categoria: 'trasdosados',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '1.00', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Anclaje universal Omega M6', cantidad: '10', unidad: 'ud' },
                    { material: 'Tornillo 3.5√ó35', cantidad: '12', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.30', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '0.8', unidad: 'ml' }
                ]
            },
            {
                id: 'R-HA-15', nombre: 'Trasdosado HA STD 15mm (Omega 17)', categoria: 'trasdosados',
                materiales: [
                    { material: 'Placa STD BA 15mm', cantidad: '1.00', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Anclaje universal Omega M6', cantidad: '10', unidad: 'ud' },
                    { material: 'Tornillo 3.5√ó35', cantidad: '12', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.35', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '0.8', unidad: 'ml' }
                ]
            },
            {
                id: 'R-HA-AQ-13', nombre: 'Trasdosado HA AQUA 13mm (Omega 17)', categoria: 'trasdosados',
                materiales: [
                    { material: 'Placa AQUA 13mm', cantidad: '1.00', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Anclaje universal Omega M6', cantidad: '10', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '12', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.30', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '0.8', unidad: 'ml' },
                    { material: 'Banda estanca 50mm', cantidad: '0.4', unidad: 'ml' }
                ]
            },
            {
                id: 'R-BL-13', nombre: 'Trasdosado Bloque STD 13mm (Omega 17)', categoria: 'trasdosados',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '1.00', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Anclaje directo (304029)', cantidad: '8', unidad: 'ud' },
                    { material: 'Tornillo 3.5√ó35', cantidad: '12', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.30', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '0.8', unidad: 'ml' }
                ]
            },
            {
                id: 'R-BL-AQ-13', nombre: 'Trasdosado Bloque AQUA 13mm (Omega 17)', categoria: 'trasdosados',
                materiales: [
                    { material: 'Placa AQUA 13mm', cantidad: '1.00', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Anclaje directo (304029)', cantidad: '8', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '12', unidad: 'ud' },
                    { material: 'FASSAJOINT 1H', cantidad: '0.30', unidad: 'kg' },
                    { material: 'Cinta papel', cantidad: '0.8', unidad: 'ml' },
                    { material: 'Banda estanca 50mm', cantidad: '0.4', unidad: 'ml' }
                ]
            },
            {
                id: 'R-BL-EX-13', nombre: 'Trasdosado Bloque EXTERNA 13mm (Omega 17)', categoria: 'trasdosados',
                materiales: [
                    { material: 'Placa EXTERNA Light 13mm', cantidad: '1.00', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Anclaje directo (304029)', cantidad: '8', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '12', unidad: 'ud' },
                    { material: 'FASSA A 64', cantidad: '0.35', unidad: 'kg' },
                    { material: 'Malla fibra vidrio 100mm', cantidad: '0.8', unidad: 'ml' },
                    { material: 'Banda estanca 70mm', cantidad: '0.5', unidad: 'ml' }
                ]
            },
            // TECHOS (5 SISTEMAS)
            {
                id: 'C-TC47-13', nombre: 'Cielo Falso TC 47 + STD 13mm', categoria: 'techos',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '1.10', unidad: 'm¬≤' },
                    { material: 'TC 47 Z1', cantidad: '2.00', unidad: 'ml' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó25', cantidad: '16', unidad: 'ud' },
                    { material: 'Horquilla cuelgue TC 47', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Suspensi√≥n TC 47 (180mm)', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Varilla roscada √ò6√ó1000', cantidad: '0.30', unidad: 'm' }
                ]
            },
            {
                id: 'C-TC48-13', nombre: 'Cielo Falso TC 48 + STD 13mm', categoria: 'techos',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '1.10', unidad: 'm¬≤' },
                    { material: 'TC 48 Z1', cantidad: '2.00', unidad: 'ml' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó25', cantidad: '16', unidad: 'ud' },
                    { material: 'Horquilla cuelgue TC 48', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Suspensi√≥n TC 48 (180mm)', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Varilla roscada √ò6√ó1000', cantidad: '0.30', unidad: 'm' }
                ]
            },
            {
                id: 'C-TC47-AQ', nombre: 'Cielo Falso TC 47 + AQUA 13mm', categoria: 'techos',
                materiales: [
                    { material: 'Placa AQUA 13mm', cantidad: '1.10', unidad: 'm¬≤' },
                    { material: 'TC 47 Z1', cantidad: '2.00', unidad: 'ml' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Tornillo Inox 3.5√ó25', cantidad: '16', unidad: 'ud' },
                    { material: 'Horquilla cuelgue TC 47', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Suspensi√≥n TC 47 (180mm)', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Varilla roscada √ò6√ó1000', cantidad: '0.30', unidad: 'm' }
                ]
            },
            {
                id: 'C-O17-13', nombre: 'Cielo Bajo Omega 17 + STD 13mm', categoria: 'techos',
                materiales: [
                    { material: 'Placa STD BA 13mm', cantidad: '1.10', unidad: 'm¬≤' },
                    { material: 'Omega 17 Z1', cantidad: '2.00', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó25', cantidad: '16', unidad: 'ud' },
                    { material: 'Anclaje directo (304029)', cantidad: '8', unidad: 'ud' },
                    { material: 'Clip Z1 U201928300A', cantidad: '2.0', unidad: 'ud' }
                ]
            },
            {
                id: 'C-TC47-15', nombre: 'Cielo Falso TC 47 + STD 15mm', categoria: 'techos',
                materiales: [
                    { material: 'Placa STD BA 15mm', cantidad: '1.10', unidad: 'm¬≤' },
                    { material: 'TC 47 Z1', cantidad: '2.00', unidad: 'ml' },
                    { material: 'Omega 17 Z1', cantidad: '0.50', unidad: 'ml' },
                    { material: 'Tornillo placa-metal 3.5√ó35', cantidad: '14', unidad: 'ud' },
                    { material: 'Horquilla cuelgue TC 47', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Suspensi√≥n TC 47 (180mm)', cantidad: '2.5', unidad: 'ud' },
                    { material: 'Varilla roscada √ò6√ó1000', cantidad: '0.30', unidad: 'm' }
                ]
            },
            // SEMI-INTEMPERIE (2 SISTEMAS - Eliminado SI-AQ-70-13)
            {
                id: 'SI-EX-70-13', nombre: 'Semi-Intemperie EXTERNA 116mm (70mm)', categoria: 'semi-intemperie',
                materiales: [
                    { material: 'Placa EXTERNA Light 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 70mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 70mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '20', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSA A 64', cantidad: '0.45', unidad: 'kg' },
                    { material: 'Malla fibra vidrio 100mm', cantidad: '1.0', unidad: 'ml' },
                    { material: 'Banda estanca 70mm', cantidad: '0.6', unidad: 'ml' }
                ]
            },
            {
                id: 'SI-EX-90-13', nombre: 'Semi-Intemperie EXTERNA 136mm (90mm)', categoria: 'semi-intemperie',
                materiales: [
                    { material: 'Placa EXTERNA Light 13mm', cantidad: '2.00', unidad: 'm¬≤' },
                    { material: 'Montante Z1 90mm', cantidad: '2.50', unidad: 'ml' },
                    { material: 'Canal Z1 90mm', cantidad: '0.70', unidad: 'ml' },
                    { material: 'Tornillo Inox 3.5√ó35', cantidad: '20', unidad: 'ud' },
                    { material: 'Tornillo Inox 3.5√ó9.5', cantidad: '30', unidad: 'ud' },
                    { material: 'FASSA A 64', cantidad: '0.50', unidad: 'kg' },
                    { material: 'Malla fibra vidrio 100mm', cantidad: '1.0', unidad: 'ml' },
                    { material: 'Banda estanca 70mm', cantidad: '0.6', unidad: 'ml' }
                ]
            }
        ];

        // CAT√ÅLOGO DE MATERIALES CON PRECIOS
        const catalogoMateriales = {
            "L00A003200A0": {
                name: "Gypsotech STD BA 13 1200x2000",
                family: "placa",
                usage_scope: ["interior"],
                unit: "m2",
                price: 6.26,
                waste_percent: 0.08,
                meta: { m2_per_pallet: 60.0, price_origin: "DEP√ìSITO CATALU√ëA" }
            },
            "L00A003240A0": {
                name: "Gypsotech STD BA 13 1200x2400",
                family: "placa",
                usage_scope: ["interior"],
                unit: "m2",
                price: 6.26,
                waste_percent: 0.08,
                meta: { m2_per_pallet: 50.0, price_origin: "DEP√ìSITO CATALU√ëA" }
            },
            "L00A005200A0": {
                name: "Gypsotech STD BA 15 1200x2000",
                family: "placa",
                usage_scope: ["interior"],
                unit: "m2",
                price: 7.80,
                waste_percent: 0.08,
                meta: { m2_per_pallet: 50.0, price_origin: "DEP√ìSITO CATALU√ëA" }
            },
            "L00H003200A0": {
                name: "Gypsotech AQUA H2 BA 13 1200x2000",
                family: "placa",
                usage_scope: ["humedo"],
                unit: "m2",
                price: 9.59,
                waste_percent: 0.08,
                meta: { m2_per_pallet: 60.0, price_origin: "DEP√ìSITO CATALU√ëA" }
            },
            "L00H005200A0": {
                name: "Gypsotech AQUA H2 BA 15 1200x2000",
                family: "placa",
                usage_scope: ["humedo"],
                unit: "m2",
                price: 11.81,
                waste_percent: 0.08,
                meta: { m2_per_pallet: 50.0, price_origin: "DEP√ìSITO CATALU√ëA" }
            },
            "L00XL03200EI": {
                name: "Gypsotech EXTERNA light 13 1200x2000",
                family: "placa",
                usage_scope: ["exterior_protegido"],
                unit: "m2",
                price: 28.73,
                waste_percent: 0.08,
                meta: { m2_per_pallet: 50.0, price_origin: "DEP√ìSITO CATALU√ëA" }
            },
            "C344836279A": {
                name: "Montante 48/35 Z1 L=2.790",
                family: "perfil_muro",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.40,
                waste_percent: 0.08
            },
            "C367038299A": {
                name: "Montante 70/37 Z1 L=2.990",
                family: "perfil_muro",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.78,
                waste_percent: 0.08
            },
            "C399041359A": {
                name: "Montante 90/40 Z1 L=3.590",
                family: "perfil_muro",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 2.23,
                waste_percent: 0.08
            },
            "U304830300A": {
                name: "Rail 48 Z1 L=3.000",
                family: "perfil_muro",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.18,
                waste_percent: 0.08
            },
            "U307030300A": {
                name: "Rail 70 Z1 L=3.000",
                family: "perfil_muro",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.43,
                waste_percent: 0.08
            },
            "U309030300A": {
                name: "Rail 90 Z1 L=3.000",
                family: "perfil_muro",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.75,
                waste_percent: 0.08
            },
            "C174717300A": {
                name: "Perfil TC 47 Z1 L=3.000",
                family: "perfil_techo",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.13,
                waste_percent: 0.08
            },
            "C1548300BA": {
                name: "Perfil TC 48 Z1 L=3.000",
                family: "perfil_techo",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 2.50,
                waste_percent: 0.08
            },
            "E168218300A": {
                name: "Perfil techo continuo Omega 17 Z1 L=3.000",
                family: "perfil_techo",
                usage_scope: ["interior", "humedo"],
                unit: "ml",
                price: 1.33,
                waste_percent: 0.08
            },
            "304000": {
                name: "Horquilla cuelgue (suspensi√≥n)",
                family: "accesorio_techo",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 19.48,
                waste_percent: 0.08,
                package_size: 100
            },
            "304029": {
                name: "Anclaje directo TC 47",
                family: "accesorio_techo",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 33.95,
                waste_percent: 0.08,
                package_size: 100
            },
            "304036": {
                name: "Anclaje universal Omega M6",
                family: "accesorio_techo",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 39.38,
                waste_percent: 0.08,
                package_size: 100
            },
            "304095": {
                name: "Varilla roscada M6 √ò6 x 1000",
                family: "accesorio_techo",
                usage_scope: ["interior", "humedo"],
                unit: "ud",
                price: 0.88,
                waste_percent: 0.08
            },
            "304115": {
                name: "Tornillo rosca fina √ò3,5x25 (caja 1000)",
                family: "tornilleria",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 22.33,
                waste_percent: 0.08,
                package_size: 1000
            },
            "304104": {
                name: "Tornillo rosca fina √ò3,5x35 (caja 1000)",
                family: "tornilleria",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 17.28,
                waste_percent: 0.08,
                package_size: 1000
            },
            "304134": {
                name: "Tornillo metal-metal √ò3,5x9,5 (caja 1000)",
                family: "tornilleria",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 14.38,
                waste_percent: 0.08,
                package_size: 1000
            },
            "351E1": {
                name: "FASSAJOINT 1H Blanco 10 kg",
                family: "juntas",
                usage_scope: ["interior", "humedo"],
                unit: "saco",
                price: 13.27,
                waste_percent: 0.08,
                package_size: 10
            },
            "304058": {
                name: "Cinta juntas (papel) 150 m (caja x10)",
                family: "juntas",
                usage_scope: ["interior", "humedo"],
                unit: "caja",
                price: 8.38,
                waste_percent: 0.08,
                package_size: 10
            },
            "304075": {
                name: "Banda autoadhesiva estanca 50 mm x 30 m",
                family: "banda",
                usage_scope: ["interior", "humedo", "exterior_protegido"],
                unit: "ud",
                price: 11.58,
                waste_percent: 0.08
            },
            "304078": {
                name: "Malla fibra de vidrio",
                family: "malla",
                usage_scope: ["exterior_protegido", "interior", "humedo"],
                unit: "caja",
                price: 4.75,
                waste_percent: 0.08,
                package_size: 54
            },
            "647": {
                name: "A64 R-EVOLUTION Marfil 25 kg",
                family: "mortero_exterior",
                usage_scope: ["exterior_protegido"],
                unit: "saco",
                price: 22.61,
                waste_percent: 0.08,
                package_size: 25
            }
        };
        
        // Funci√≥n para calcular precio de materiales
        function calcularPrecioMaterial(materialId, cantidad) {
            const material = catalogoMateriales[materialId];
            if (!material) return 0;
            
            const cantidadConMerma = cantidad * (1 + material.waste_percent);
            return cantidadConMerma * material.price;
        }
        
        // Funci√≥n para validar uso de material
        function validarUsoMaterial(materialId, ambiente) {
            const material = catalogoMateriales[materialId];
            if (!material) return false;
            
            return material.usage_scope.includes(ambiente);
        }
        
        // Funci√≥n para obtener informaci√≥n de material
        function getMaterialInfo(materialId) {
            return catalogoMateriales[materialId] || null;
        }
        
        // Funci√≥n para calcular costo total de un sistema
        function calcularCostoSistema(sistemaId, cantidadM2) {
            const sistema = sistemas.find(s => s.id === sistemaId);
            if (!sistema || !sistema.materiales) return 0;
            
            let costoTotal = 0;
            
            sistema.materiales.forEach(mat => {
                const cantidadMaterial = parseFloat(mat.cantidad) * cantidadM2;
                costoTotal += calcularPrecioMaterial(mat.materialId || mat.material, cantidadMaterial);
            });
            
            return costoTotal;
        }
        
        // Funci√≥n para agregar IDs de material a los sistemas
        function agregarMaterialIds() {
            const mapeoMateriales = {
                "Placa STD BA 13mm": "L00A003200A0",
                "Placa STD BA 15mm": "L00A005200A0",
                "Placa AQUA 13mm": "L00H003200A0",
                "Placa AQUA 15mm": "L00H005200A0",
                "Placa EXTERNA Light 13mm": "L00XL03200EI",
                "Montante Z1 45mm": "C344836279A",
                "Montante Z1 70mm": "C367038299A",
                "Montante Z1 90mm": "C399041359A",
                "Canal Z1 45mm": "U304830300A",
                "Canal Z1 70mm": "U307030300A",
                "Canal Z1 90mm": "U309030300A",
                "Tornillo placa-metal 3.5√ó25": "304115",
                "Tornillo placa-metal 3.5√ó35": "304104",
                "Tornillo metal-metal 3.5√ó9.5": "304134",
                "Tornillo Inox 3.5√ó25": "304115",
                "Tornillo Inox 3.5√ó35": "304104",
                "Tornillo Inox 3.5√ó9.5": "304134",
                "FASSAJOINT 1H": "351E1",
                "Cinta papel": "304058",
                "Banda estanca 50mm": "304075",
                "Banda estanca 70mm": "304075",
                "Malla fibra vidrio 100mm": "304078",
                "FASSA A 64": "647",
                "Omega 17 Z1": "E168218300A",
                "Anclaje universal Omega M6": "304036",
                "Anclaje directo (304029)": "304029",
                "TC 47 Z1": "C174717300A",
                "TC 48 Z1": "C1548300BA",
                "Horquilla cuelgue TC 47": "304000",
                "Horquilla cuelgue TC 48": "304000",
                "Suspensi√≥n TC 47 (180mm)": "304022",
                "Suspensi√≥n TC 48 (180mm)": "304022",
                "Varilla roscada √ò6√ó1000": "304095",
                "Clip Z1 U201928300A": "U201928300A"
            };
            
            sistemas.forEach(sistema => {
                if (sistema.materiales) {
                    sistema.materiales.forEach(material => {
                        material.materialId = mapeoMateriales[material.material] || null;
                    });
                }
            });
        }
        
        // Llamar al inicio
        agregarMaterialIds();

        function renderBudget() {
            const budget = JSON.parse(localStorage.getItem('fassa_budget') || '[]');
            const tbody = document.getElementById('budgetTableBody');
            
            if (budget.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:3rem;">No hay sistemas en el presupuesto. <a href="tabiques.html">A√±ade desde el selector</a></td></tr>';
                document.getElementById('totalM2').textContent = '0';
                document.getElementById('totalSistemas').textContent = '0';
                document.getElementById('totalPresupuesto').textContent = '$0.00';
                document.getElementById('budgetTableFooter').style.display = 'none';
                return;
            }

            let totalM2 = 0;
            let totalPresupuesto = 0;
            tbody.innerHTML = budget.map(item => {
                totalM2 += item.quantity;
                const precioM2 = calcularCostoSistema(item.id, 1);
                const subtotal = precioM2 * item.quantity;
                totalPresupuesto += subtotal;
                
                return `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.id}</td>
                        <td><input type="number" class="qty-input" value="${item.quantity}" onchange="updateQuantity('${item.id}', this.value)"> m¬≤</td>
                        <td style="text-align:right;">$${precioM2.toFixed(2)}</td>
                        <td style="text-align:right;">$${subtotal.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="removeFromBudget('${item.id}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('totalM2').textContent = totalM2.toLocaleString('es-ES');
            document.getElementById('totalSistemas').textContent = budget.length;
            document.getElementById('totalPresupuesto').textContent = `$${totalPresupuesto.toFixed(2)}`;
            document.getElementById('budgetTableFooter').style.display = 'table-footer-group';
            
            calcularMaterialesTotales();
        }

        function updateQuantity(id, newQty) {
            const budget = JSON.parse(localStorage.getItem('fassa_budget') || '[]');
            const item = budget.find(i => i.id === id);
            if (item) {
                item.quantity = parseFloat(newQty) || 0;
                localStorage.setItem('fassa_budget', JSON.stringify(budget));
                renderBudget();
            }
        }

        function removeFromBudget(id) {
            if (confirm('¬øEliminar sistema del presupuesto?')) {
                let budget = JSON.parse(localStorage.getItem('fassa_budget') || '[]');
                budget = budget.filter(i => i.id !== id);
                localStorage.setItem('fassa_budget', JSON.stringify(budget));
                renderBudget();
            }
        }

        function clearBudget() {
            if (confirm('¬øVaciar todo el presupuesto?')) {
                localStorage.removeItem('fassa_budget');
                renderBudget();
            }
        }

        function calcularMaterialesTotales() {
            const budget = JSON.parse(localStorage.getItem('fassa_budget') || '[]');
            const materialesTotales = {};
            let totalPrecio = 0;
            
            budget.forEach(item => {
                const sistema = sistemas.find(s => s.id === item.id);
                if (sistema && sistema.materiales) {
                    sistema.materiales.forEach(mat => {
                        const key = `${mat.material}|${mat.unidad}`;
                        if (!materialesTotales[key]) {
                            materialesTotales[key] = { 
                                material: mat.material, 
                                unidad: mat.unidad, 
                                cantidad: 0,
                                precioUnitario: 0,
                                subtotal: 0
                            };
                        }
                        const cantidadMaterial = parseFloat(mat.cantidad) * item.quantity;
                        materialesTotales[key].cantidad += cantidadMaterial;
                        
                        // Calcular precio
                        const precioMaterial = calcularPrecioMaterial(mat.materialId || mat.material, cantidadMaterial);
                        materialesTotales[key].precioUnitario = calcularPrecioMaterial(mat.materialId || mat.material, 1);
                        materialesTotales[key].subtotal += precioMaterial;
                        totalPrecio += precioMaterial;
                    });
                }
            });

            document.getElementById('materialsTotalBody').innerHTML = Object.values(materialesTotales).map(mat => `
                <tr>
                    <td style="padding:1rem;">${mat.material}</td>
                    <td style="padding:1rem; text-align:center;">${mat.cantidad.toFixed(2)}</td>
                    <td style="padding:1rem; text-align:center;">${mat.unidad}</td>
                    <td style="padding:1rem; text-align:right;">$${mat.precioUnitario.toFixed(2)}</td>
                    <td style="padding:1rem; text-align:right;">$${mat.subtotal.toFixed(2)}</td>
                </tr>
            `).join('');
            
            // Actualizar total
            document.getElementById('totalMaterialesPrecio').textContent = `$${totalPrecio.toFixed(2)}`;
            
            // Mostrar/ocultar secciones
            if (budget.length > 0) {
                document.getElementById('materialsBreakdown').style.display = 'block';
                document.getElementById('priceSummary').style.display = 'block';
                actualizarResumenCostos(totalPrecio);
            } else {
                document.getElementById('materialsBreakdown').style.display = 'none';
                document.getElementById('priceSummary').style.display = 'none';
            }
        }

        function actualizarResumenCostos(totalMateriales) {
            const mermas = totalMateriales * 0.08; // 8% de merma general
            const subtotalConMermas = totalMateriales + mermas;
            const iva = subtotalConMermas * 0.21; // 21% IVA
            const totalFinal = subtotalConMermas + iva;
            
            document.getElementById('subtotalMateriales').textContent = `$${totalMateriales.toFixed(2)}`;
            document.getElementById('mermas').textContent = `$${mermas.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('totalFinal').textContent = `$${totalFinal.toFixed(2)}`;
        }

        function exportMaterialsList() {
            if (!document.getElementById('disclaimerCheck').checked) {
                alert('‚ö†Ô∏è Debe confirmar que ha revisado las especificaciones t√©cnicas antes de exportar.');
                return;
            }
            
            const budget = JSON.parse(localStorage.getItem('fassa_budget') || '[]');
            if (budget.length === 0) {
                alert('No hay materiales para exportar.');
                return;
            }
            
            alert('Exportando lista de materiales con precios...\n\nFuncionalidad de exportaci√≥n a Excel en desarrollo.');
        }

        function exportBudgetPDF() {
            if (!document.getElementById('disclaimerCheck').checked) {
                alert('‚ö†Ô∏è Debe confirmar que ha revisado las especificaciones t√©cnicas antes de exportar.');
                return;
            }
            
            const budget = JSON.parse(localStorage.getItem('fassa_budget') || '[]');
            if (budget.length === 0) {
                alert('No hay presupuesto para exportar.');
                return;
            }
            
            alert('Exportando PDF de presupuesto...\n\nFuncionalidad de exportaci√≥n a PDF en desarrollo.');
        }

        function toggleExportButtons() {
            const check = document.getElementById('disclaimerCheck');
            const excelBtn = document.querySelector('button[onclick="exportMaterialsList()"]');
            const pdfBtn = document.querySelector('button[onclick="exportBudgetPDF()"]');
            
            if (check && excelBtn && pdfBtn) {
                excelBtn.disabled = !check.checked;
                pdfBtn.disabled = !check.checked;
                
                if (check.checked) {
                    excelBtn.style.opacity = '1';
                    pdfBtn.style.opacity = '1';
                } else {
                    excelBtn.style.opacity = '0.5';
                    pdfBtn.style.opacity = '0.5';
                }
            }
        }

        // Llamar al inicio
        toggleExportButtons();
        renderBudget();
    </script>
</body>
</html>
