<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
  <meta name="theme-color" content="#2c3e50" />
  <title>Proyecto – AriasGroupCaribe SRL</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --rojo:#e74c3c;
      --gris:#2c3e50;
      --light:#ecf0f1;
      --font-base:16px;
      --space-xs:0.5rem;
      --space-sm:0.75rem;
      --space-md:1rem;
      --space-lg:1.5rem;
      --space-xl:2rem;
      --tap-target:3rem;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0;
      background:var(--light);
      color:#333;
      font-size:var(--font-base);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .header{
      background:var(--gris);
      color:#fff;
      padding:var(--space-sm) var(--space-md);
      display:flex;
      align-items:center;
      gap:var(--space-sm);
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .header .logo{
      font-size:1.125rem;
      font-weight:800;
      color:var(--rojo);
      flex:1;
      min-width:0;
    }
    .header .back{
      color:#fff;
      text-decoration:none;
      display:flex;
      align-items:center;
      gap:var(--space-xs);
      padding:var(--space-xs);
      min-height:var(--tap-target);
      min-width:var(--tap-target);
      justify-content:center;
      border-radius:0.5rem;
      transition:background-color 0.2s;
    }
    .header .back:active{background-color:rgba(255,255,255,.1)}
    .container{
      max-width:75rem;
      margin:0 auto;
      padding:var(--space-md);
    }
    .card{
      background:#fff;
      border-radius:0.75rem;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      padding:var(--space-md);
      margin-bottom:var(--space-md);
    }
    h3{
      margin:0 0 var(--space-md) 0;
      color:var(--gris);
      border-bottom:2px solid var(--rojo);
      padding-bottom:var(--space-xs);
      font-size:1.125rem;
      font-weight:700;
    }
    .row{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
    }
    label{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
      font-size:0.875rem;
      width:100%;
    }
    input[type="text"],
    input[type="number"],
    select{
      width:100%;
      max-width:100%;
      padding:var(--space-md);
      font-size:var(--font-base);
      border:1px solid #ccc;
      border-radius:0.5rem;
      background:#fff;
      min-height:var(--tap-target);
      -webkit-appearance:none;
      appearance:none;
    }
    input:focus,select:focus{
      outline:2px solid var(--rojo);
      outline-offset:2px;
      border-color:var(--rojo);
    }
    select{
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 1rem center;
      padding-right:2.5rem;
      word-break:break-word;
    }
    select option{word-break:break-word}
    button{
      width:100%;
      padding:var(--space-md);
      border:0;
      border-radius:0.5rem;
      background:var(--rojo);
      color:#fff;
      font-size:var(--font-base);
      font-weight:600;
      cursor:pointer;
      min-height:var(--tap-target);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:var(--space-xs);
      transition:background-color 0.2s,transform 0.1s;
      position:relative;
      overflow:hidden;
    }
    button:active{
      background:#c0392b;
      transform:scale(0.98);
    }
    button:active::after{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,.3);
      transform:translate(-50%,-50%);
      animation:ripple 0.4s ease-out;
    }
    @keyframes ripple{
      to{width:200px;height:200px;opacity:0}
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-sm);
      margin-top:var(--space-md);
    }
    .meta .item{
      background:var(--light);
      border-radius:0.5rem;
      padding:var(--space-xs) var(--space-sm);
      font-size:0.8125rem;
      color:#555;
    }
    .table-wrapper{
      overflow-x:auto;
      margin-top:var(--space-md);
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
    }
    .table-wrapper::-webkit-scrollbar{
      height:0.5rem;
    }
    .table-wrapper::-webkit-scrollbar-thumb{
      background:#ccc;
      border-radius:0.25rem;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.875rem;
      min-width:600px;
    }
    th,td{
      border-bottom:1px solid #eee;
      padding:var(--space-sm) var(--space-xs);
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#666;
      font-weight:600;
      background:#f8f9fa;
      position:sticky;
      top:0;
      z-index:1;
    }
    .num{
      font-variant-numeric:tabular-nums;
      text-align:right;
    }
    .totals{
      background:var(--gris);
      color:#fff;
      border-radius:0.5rem;
      padding:var(--space-md);
      margin-top:var(--space-md);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      text-align:center;
      position:sticky;
      bottom:0;
      z-index:10;
      box-shadow:0 -2px 8px rgba(0,0,0,.1);
    }
    .totals .lbl{
      font-size:0.75rem;
      opacity:.9;
    }
    .totals .val{
      font-size:1.5rem;
      font-weight:700;
    }
    .actions{
      margin-top:var(--space-md);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .actions button{
      width:100%;
    }
    .btn-icon-only .btn-label{
      display:none;
    }
    .btn-small{
      padding:var(--space-xs);
      font-size:0.75rem;
      min-height:2.5rem;
      min-width:2.5rem;
      width:auto;
    }
    .muted{
      color:#7f8c8d;
      font-size:0.75rem;
      margin-top:var(--space-sm);
      line-height:1.6;
    }
    #projTable th{
      background:var(--rojo);
      color:#fff;
    }
    #fileInput{display:none}
    @media (min-width:48rem){
      .container{padding:var(--space-lg)}
      .card{padding:var(--space-lg);margin-bottom:var(--space-lg)}
      .header{padding:var(--space-md) var(--space-lg)}
      .header .logo{font-size:1.375rem}
      h3{font-size:1.25rem;margin-bottom:var(--space-lg)}
      .row{
        flex-direction:row;
        flex-wrap:wrap;
        gap:var(--space-md);
        align-items:flex-end;
      }
      label{
        flex:1 1 auto;
        min-width:0;
      }
      input[type="text"],
      input[type="number"],
      select{
        max-width:7.5rem;
      }
      label[style*="flex:1 1 100%"] input{
        max-width:100%;
      }
      button{
        width:auto;
        padding:var(--space-sm) var(--space-md);
        min-width:auto;
      }
      .meta{gap:var(--space-md)}
      .meta .item{font-size:0.875rem;padding:var(--space-xs) var(--space-sm)}
      table{font-size:0.9375rem;min-width:auto}
      th,td{padding:var(--space-sm) var(--space-xs)}
      th{font-size:0.8125rem}
      .totals{
        flex-direction:row;
        gap:var(--space-xl);
        text-align:left;
        position:relative;
        box-shadow:none;
      }
      .totals .val{font-size:1.3125rem}
      .actions{
        flex-direction:row;
        gap:var(--space-md);
      }
      .actions button{width:auto;flex:1}
      .btn-icon-only .btn-label{display:inline}
      .muted{text-align:left}
    }
    @media (min-width:64rem){
      .container{max-width:75rem}
      .card{padding:var(--space-xl)}
      h3{font-size:1.5rem}
      .row{gap:var(--space-lg)}
      label{flex:1 1 220px}
      input[type="text"],
      input[type="number"],
      select{max-width:7.5rem}
      table{font-size:0.9375rem}
    }
  </style>
</head>
<body>
  <header class="header">
    <i class="fas fa-project-diagram" aria-hidden="true"></i>
    <div class="logo">AriasGroupCaribe SRL</div>
    <a class="back" href="index.html" aria-label="Volver al inicio"><i class="fas fa-arrow-left" aria-hidden="true"></i> <span>Volver</span></a>
  </header>

  <div class="container">
    <div class="card">
      <h3>Proyecto</h3>
      <div class="row">
        <label style="flex:1 1 100%">
          Nombre del Proyecto
          <input id="projectName" type="text" placeholder="Ej: Edificio Residencial Calle Mayor" />
        </label>
      </div>
    </div>

    <div class="card">
      <h3>Añadir Sistema al Proyecto</h3>
      
      <!-- Flujo de selección por criterios -->
      <div id="selectionFlow" style="margin-bottom: 1rem;">
        <!-- Paso 1: Ambiente -->
        <div id="step1" class="step-container">
          <div class="row">
            <label>
              Ambiente
              <select id="selectAmbiente">
                <option value="">Seleccionar...</option>
                <option value="seco">seco</option>
                <option value="humedo">humedo</option>
                <option value="semi-intemperie">semi-intemperie</option>
              </select>
            </label>
          </div>
        </div>
        
        <!-- Paso 2: Elemento -->
        <div id="step2" class="step-container" style="display: none;">
          <div class="row">
            <label>
              Elemento
              <select id="selectElemento" disabled>
                <option value="">Primero selecciona Ambiente</option>
                <option value="MURO">muro</option>
                <option value="TRASDOSADO">trasdosado</option>
                <option value="TECHO">techo</option>
                <option value="EXTERIOR" style="display: none;" id="elementoEXTERIOROption">semi-intemperie</option>
              </select>
            </label>
          </div>
        </div>
        
        <!-- Paso 3: Placa -->
        <div id="step3" class="step-container" style="display: none;">
          <div class="row">
            <label>
              Placa
              <select id="selectPlaca" disabled>
                <option value="">Primero selecciona Elemento</option>
              </select>
            </label>
          </div>
        </div>
        
        <!-- Paso 4: Estructura/Perfilería -->
        <div id="step4" class="step-container" style="display: none;">
          <div class="row">
            <label>
              Estructura/Perfilería
              <select id="selectEstructura" disabled>
                <option value="">Primero selecciona Placa</option>
              </select>
            </label>
          </div>
        </div>
        
        <!-- Paso 5: Capas -->
        <div id="step5" class="step-container" style="display: none;">
          <div class="row">
            <label>
              Capas
              <select id="selectCapas" disabled>
                <option value="">Primero selecciona Estructura/Perfilería</option>
              </select>
            </label>
          </div>
        </div>
        
        <!-- Resultado: Sistemas encontrados -->
        <div id="stepResult" class="step-container" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div id="resultadoContainer">
            <!-- Se llena dinámicamente -->
          </div>
        </div>
      </div>
      
      <!-- Campos de entrada -->
      <div class="row" style="margin-top: 1rem;">
        <label>
          m² (superficie)
          <input id="area" type="number" step="0.01" value="100" />
        </label>
        <label>
          Desperdicio %
          <input id="waste" type="number" step="0.1" value="5" />
        </label>
        <button id="addBtn"><i class="fas fa-plus" aria-hidden="true"></i> Añadir</button>
      </div>
      <div class="row" style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
        <label>
          Incoterm
          <select id="incoterm">
            <option value="EXW">EXW</option>
            <option value="FOB">FOB</option>
            <option value="CIF" selected>CIF</option>
          </select>
        </label>
        <label>
          Logística %
          <input id="logisticaPct" type="number" step="0.1" value="12" />
        </label>
        <label>
          Margen %
          <input id="margenPct" type="number" step="0.1" value="30" />
        </label>
      </div>
      
      <!-- Información del sistema (read-only) -->
      <div id="fichaTecnica" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; display: none;">
        <h4 style="margin-top: 0; margin-bottom: 0.75rem; color: #2c3e50; font-size: 1rem;">Información del sistema</h4>
        <div id="fichaTecnicaContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.875rem; color: #495057;"></div>
      </div>
      
      <!-- Descripción del sistema -->
      <div id="descripcionTecnica" style="margin-top: 1rem; padding: 1rem; background: #fff; border-left: 3px solid #3498db; display: none;">
        <h4 style="margin-top: 0; margin-bottom: 0.5rem; color: #2c3e50; font-size: 0.95rem;">Descripción del sistema</h4>
        <div id="descripcionTecnicaContent" style="font-size: 0.875rem; color: #495057; line-height: 1.6;"></div>
      </div>
      
      <div id="resumenSistema" style="margin-top: 1rem; padding: 1rem; background: #e8f4f8; border-radius: 4px; display: none;">
        <h4 style="margin-top: 0;">Resumen del Sistema</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
          <div><strong>Coste neto:</strong> <span id="resumenCosteNeto">—</span></div>
          <div><strong>Logística:</strong> <span id="resumenLogistica">—</span></div>
          <div><strong>Coste total:</strong> <span id="resumenCosteTotal">—</span></div>
          <div><strong>Margen:</strong> <span id="resumenMargen">—</span></div>
          <div><strong>Precio <span id="resumenIncotermLabel">CIF</span> /m²:</strong> <span id="resumenVentaM2">—</span></div>
          <div><strong>Total sistema:</strong> <span id="resumenTotal" style="font-size: 1.1em; font-weight: bold; color: #e74c3c;">—</span></div>
        </div>
      </div>
      
      <div class="table-wrapper">
        <table id="tbl">
          <thead>
            <tr>
              <th>SKU</th><th>Concepto</th><th>Unidad</th><th>Precio Cat.</th><th>Dto %</th><th>Precio Neto</th><th>Coef</th><th>Cantidad</th><th>Importe Neto</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Proyecto Acumulado</h3>
      <div class="table-wrapper">
        <table id="projTable">
          <thead>
            <tr>
              <th>Sistema</th><th>m²</th><th>Precio/m²</th><th>Total €</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="totals">
        <div><div class="lbl">Total Proyecto</div><div class="val" id="projTotal">—</div></div>
      </div>
    </div>

    <div class="card">
      <h3>Exportar</h3>
      <div class="actions">
        <button id="pdfBtn" class="btn-icon-only" style="background:#e74c3c"><i class="fas fa-file-pdf" aria-hidden="true"></i> <span class="btn-label">PDF (Cliente)</span></button>
        <button id="excelBtn" class="btn-icon-only" style="background:#27ae60"><i class="fas fa-file-excel" aria-hidden="true"></i> <span class="btn-label">Excel (Control Interno)</span></button>
      </div>
      <div class="muted">
        <strong>PDF:</strong> Resumen para cliente (sistemas, materiales, rendimiento, precio/m², total)<br>
        <strong>Excel:</strong> Desglose completo para control interno
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Helpers de formato numérico ES-ES
    function fmtNumber(value, decimals = 2) {
      const n = Number(value);
      if (!Number.isFinite(n)) return "-";
      return n.toLocaleString("es-ES", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }
    
    function fmtEUR(value) {
      const n = Number(value);
      if (!Number.isFinite(n)) return "- €";
      return n.toLocaleString("es-ES", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + " €";
    }
    
    // Mantener EUR para compatibilidad temporal (deprecated)
    const EUR = n => fmtEUR(n);
    const LOGO_SVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgMjAwIiB3aWR0aD0iODAwIiBoZWlnaHQ9IjIwMCI+PHRleHQgeD0iMjAiIHk9IjExMCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjkwIiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSIjZTc0YzNjIj5BUklBUzwvdGV4dD48dGV4dCB4PSIyMCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzgiIGZvbnQtd2VpZ2h0PSIzMDAiIGZpbGw9IiMyYzNlNTAiPkdST1VQIENhcmliZSBTUkw8L3RleHQ+PC9zdmc+';

    // Schema adapter: compatibilidad v1/v2
    function normalizeSystemToV1(sys) {
      // Si ya tiene formato viejo (capas y placa string), devolverlo
      if (sys.capas !== undefined && sys.placa !== undefined && typeof sys.placa === 'string') {
        return sys;
      }
      
      // Convertir de nuevo schema (v2) a viejo (v1) para compatibilidad
      const placasStr = Array.isArray(sys.placas) && sys.placas.length > 0
        ? sys.placas.map(p => `${p.tipo}-${p.espesor_mm}`).join('+')
        : 'STD-13';
      
      return {
        id: sys.id,
        tipo: sys.tipo,
        perfil: sys._perfil_deprecated || (sys.perfil_mm ? `${sys.perfil_mm} ${sys.zincado || 'Z1'}` : '70 Z1'),
        modulacion_mm: sys.modulacion_mm || 600,
        placa: placasStr,
        capas: sys.capas_por_cara || sys.capas || 1,
        Hmax_m: sys.Hmax_m,
        csv: sys.csv,
        name: sys.nombre_comercial || sys.name || sys.id,
        // Mantener campos nuevos para funciones que los necesiten
        placas: sys.placas,
        capas_por_cara: sys.capas_por_cara,
        estructura: sys.estructura,
        perfil_mm: sys.perfil_mm,
        zincado: sys.zincado
      };
    }

    async function loadIndex(){
      const res = await fetch('sistemas/sistemas-index.json');
      const idx = await res.json();
      const systems = idx.systems || [];
      // Normalizar todos los sistemas al formato v1 para compatibilidad
      return systems.map(normalizeSystemToV1);
    }
    

    // Detectar formato CSV (legacy vs nuevo)
    function detectarFormatoCSV(header) {
      const h = header.map(x => x.trim().toLowerCase());
      if (h.includes('precio_catalogo_almeria') && h.includes('familia_precio')) {
        return 'nuevo';
      }
      return 'legacy';
    }
    
    // Detectar familia para formato legacy
    function detectarFamilia(concepto, codigo) {
      const upper = (concepto || '').toUpperCase();
      const codUpper = (codigo || '').toUpperCase();
      if (upper.includes('PLACA') || upper.includes('GYPSOTECH') || codUpper.startsWith('L00')) {
        return 'PLACA';
      }
      return 'RESTO';
    }
    
    // Funciones globales para detectar tipo de material (aplicación de desperdicio)
    function esPlaca(sku) {
      return typeof sku === "string" && sku.toUpperCase().startsWith("L00");
    }
    
    function esPerfileria(sku) {
      if (typeof sku !== "string") return false;
      const skuUpper = sku.toUpperCase();
      // Perfilería: Montantes (C*), Rails (U*), Omega (E*)
      // Nota: TC es etiqueta en JSON, no prefijo de SKU (los TC empiezan por C)
      return skuUpper.startsWith("C") || skuUpper.startsWith("U") || skuUpper.startsWith("E");
    }
    
    // ========== FLUJO DE SELECCIÓN PASO A PASO ==========
    let systemsIndexEnriched = [];
    let systemsIndexBase = [];
    let sistemaActualMeta = null;
    let selectionFlowInitialized = false;
    
    function setStepVisible(stepId, visible) {
      const el = document.getElementById(stepId);
      if (!el) return;
      el.style.display = visible ? 'block' : 'none';
    }
    
    function clearSelectionResult() {
      const resultadoContainer = document.getElementById('resultadoContainer');
      if (resultadoContainer) resultadoContainer.innerHTML = '';
      setStepVisible('stepResult', false);
      sistemaActualMeta = null;
    }
    
    function hideSistemaOutputs() {
      const resumen = document.getElementById('resumenSistema');
      const ficha = document.getElementById('fichaTecnica');
      const desc = document.getElementById('descripcionTecnica');
      if (resumen) resumen.style.display = 'none';
      if (ficha) ficha.style.display = 'none';
      if (desc) desc.style.display = 'none';
    }
    
    // Función para cargar sistemas index enriquecido (para filtrado)
    async function loadIndexEnriched() {
      const res = await fetch('sistemas/sistemas-index.enriched.json');
      const idx = await res.json();
      return idx.systems || [];
    }
    
    // Función para cargar sistemas index base (para metadata completa)
    async function loadIndexBase() {
      const res = await fetch('sistemas/sistemas-index.json');
      const idx = await res.json();
      return idx.systems || [];
    }
    
    // Inicializar índices al cargar la página
    document.addEventListener('DOMContentLoaded', async () => {
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      if (systemsIndexBase.length === 0) {
        systemsIndexBase = await loadIndexBase();
      }
      initSelectionFlow();
    });
    
    // Función para cargar CSV y calcular (equivalente a cargarCSV)
    async function cargarCSV(systemId) {
      if (systemsIndexBase.length === 0) {
        systemsIndexBase = await loadIndexBase();
      }
      const sistema = systemsIndexBase.find(s => s.id === systemId);
      if (!sistema) {
        throw new Error(`Sistema ${systemId} no encontrado`);
      }
      sistemaActualMeta = sistema;
      await calcularYMostrarConSistema(sistema, false);
    }
    
    // Función auxiliar: calcularYMostrar pero recibiendo el sistema directamente
    async function calcularYMostrarConSistema(meta, addToProject = false) {
      const area = toNum(document.getElementById('area').value);
      const waste = toNum(document.getElementById('waste').value);
      const logisticaPct = toNum(document.getElementById('logisticaPct').value);
      const margenPct = toNum(document.getElementById('margenPct').value);
      const incoterm = document.getElementById('incoterm').value;
      
      if (!meta || area <= 0) {
        document.getElementById('resumenSistema').style.display = 'none';
        document.getElementById('fichaTecnica').style.display = 'none';
        document.getElementById('descripcionTecnica').style.display = 'none';
        return null;
      }

      // Renderizar información del sistema (read-only)
      renderFichaTecnica(meta);
      
      // Renderizar descripción del sistema si existe
      renderDescripcionTecnica(meta);

      const csvText = await loadCSV(meta.csv);
      const rows = parseCSV(csvText);
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      let costeNetoSistema = 0;
      const rowsData = [];

      for(const r of rows){
        try {
          const precioCatalogo = toNum(r.precio_catalogo_almeria);
          const familia = (r.familia_precio || detectarFamilia(r.concepto, r.codigo || r.sku)).trim().toUpperCase();
          
          if (!precioCatalogo) {
            throw new Error(`Falta precio_catalogo_almeria para ${r.codigo || r.concepto}`);
          }
          if (!familia || (familia !== 'PLACA' && familia !== 'RESTO')) {
            throw new Error(`Falta o inválida familia_precio para ${r.codigo || r.concepto}`);
          }
          
          // Descuento según familia
          const dtoDistribuidorPct = familia === 'PLACA' ? 60 : 55;
          const precioNeto = precioCatalogo * (1 - dtoDistribuidorPct / 100);
          
          // Rendimiento y cantidad (desperdicio solo a PLACAS y PERFILERÍA)
          const rendimiento = toNum(r.rendimiento_m2);
          const sku = (r.codigo || r.sku || '').toString();
          const aplicarDesperdicio = esPlaca(sku) || esPerfileria(sku);
          const factorDesperdicio = aplicarDesperdicio ? (1 + waste/100) : 1;
          const qty = area * rendimiento * factorDesperdicio;
          const importeNeto = qty * precioNeto;
          costeNetoSistema += importeNeto;

          rowsData.push({
            ...r,
            precioCatalogo,
            familia,
            dtoDistribuidorPct,
            precioNeto,
            rendimiento,
            qty,
            importeNeto,
            aplicarDesperdicio
          });

          const tr = document.createElement('tr');
          // Determinar decimales según unidad
          const decimalsQty = r.unidad === 'ud' ? 0 : 3;
          tr.innerHTML = `
            <td class="num">${r.codigo || r.sku}</td>
            <td>${r.concepto}</td>
            <td class="num">${r.unidad}</td>
            <td class="num">${fmtEUR(precioCatalogo)}</td>
            <td class="num">${dtoDistribuidorPct}%</td>
            <td class="num">${fmtEUR(precioNeto)}</td>
            <td class="num">${fmtNumber(rendimiento, 2)}</td>
            <td class="num">${fmtNumber(qty, decimalsQty)}</td>
            <td class="num">${fmtEUR(importeNeto)}</td>
          `;
          tbody.appendChild(tr);
        } catch(err) {
          console.error('Error procesando fila:', err, r);
        }
      }

      const costeTotalSistema = costeNetoSistema * (1 + logisticaPct / 100);
      const precioVentaSistema = costeTotalSistema / (1 - margenPct / 100);
      const precioVentaM2 = precioVentaSistema / area;

      document.getElementById('resumenCosteNeto').textContent = fmtEUR(costeNetoSistema);
      document.getElementById('resumenLogistica').textContent = `${incoterm} ${fmtNumber(logisticaPct, 1)}% (${fmtEUR(costeTotalSistema - costeNetoSistema)})`;
      document.getElementById('resumenCosteTotal').textContent = fmtEUR(costeTotalSistema);
      document.getElementById('resumenMargen').textContent = `${fmtNumber(margenPct, 1)}%`;
      document.getElementById('resumenIncotermLabel').textContent = incoterm;
      document.getElementById('resumenVentaM2').textContent = fmtEUR(precioVentaM2);
      document.getElementById('resumenTotal').textContent = fmtEUR(precioVentaSistema);
      document.getElementById('resumenSistema').style.display = 'block';

      const result = {
        system: meta.id,
        systemName: meta.nombre_comercial || meta.id,
        area,
        waste,
        incoterm,
        logisticaPct,
        margenPct,
        costeNetoSistema,
        costeTotalSistema,
        precioVentaSistema,
        costeTotalM2: costeTotalSistema / area,
        ventaM2: precioVentaM2,
        rows: rowsData,
        meta
      };

      if(addToProject){
        proyecto.push(result);
        renderProyecto();
      }

      return result;
    }
    
    // Actualizar opciones de elemento según ambiente
    async function updateElementoOptions(ambiente) {
      const selectElemento = document.getElementById('selectElemento');
      const selectPlaca = document.getElementById('selectPlaca');
      const selectEstructura = document.getElementById('selectEstructura');
      const selectCapas = document.getElementById('selectCapas');
      
      if (!selectElemento) return;
      
      // Cargar índices si están vacíos
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      
      // Filtrar sistemas por ambiente
      const sistemasFiltrados = systemsIndexEnriched.filter(sys => {
        if (!sys.ambiente_tags || !Array.isArray(sys.ambiente_tags)) return false;
        
        if (ambiente === 'seco') {
          return sys.ambiente_tags.includes('seco');
        } else if (ambiente === 'humedo') {
          return sys.ambiente_tags.includes('humedo');
        } else if (ambiente === 'semi-intemperie') {
          return sys.ambiente_tags.includes('semi-intemperie');
        }
        return false;
      });
      
      // Obtener elementos únicos (MURO, TRASDOSADO, TECHO, EXTERIOR)
      const elementosUnicos = new Set();
      sistemasFiltrados.forEach(sys => {
        const elemento = sys.elemento || sys.tipo;
        if (elemento) {
          elementosUnicos.add(elemento);
        }
      });
      
      // Ordenar elementos (MURO, TRASDOSADO, TECHO, EXTERIOR)
      const ordenElementos = ['MURO', 'TRASDOSADO', 'TECHO', 'EXTERIOR'];
      const elementosOrdenados = Array.from(elementosUnicos).sort((a, b) => {
        const idxA = ordenElementos.indexOf(a);
        const idxB = ordenElementos.indexOf(b);
        if (idxA === -1 && idxB === -1) return a.localeCompare(b);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
      });
      
      // Rellenar select de elemento
      selectElemento.innerHTML = '<option value="">Seleccionar...</option>';
      elementosOrdenados.forEach(elemento => {
        const option = document.createElement('option');
        option.value = elemento;
        option.textContent = elemento;
        selectElemento.appendChild(option);
      });
      
      // Habilitar select de elemento si hay opciones
      selectElemento.disabled = elementosOrdenados.length === 0;
      
      // Resetear y deshabilitar selects dependientes
      if (selectPlaca) {
        selectPlaca.innerHTML = '<option value="">Seleccionar...</option>';
        selectPlaca.disabled = true;
      }
      if (selectEstructura) {
        selectEstructura.innerHTML = '<option value="">Seleccionar...</option>';
        selectEstructura.disabled = true;
      }
      if (selectCapas) {
        selectCapas.innerHTML = '<option value="">Seleccionar...</option>';
        selectCapas.disabled = true;
      }
    }
    
    // Filtrar sistemas finales y mostrar resultado
    async function filtrarYMostrarSistemas() {
      const selectAmbiente = document.getElementById('selectAmbiente');
      const selectElemento = document.getElementById('selectElemento');
      const selectPlaca = document.getElementById('selectPlaca');
      const selectEstructura = document.getElementById('selectEstructura');
      const selectCapas = document.getElementById('selectCapas');
      
      if (!selectAmbiente || !selectElemento || !selectPlaca || !selectEstructura || !selectCapas) {
        return;
      }
      
      const ambiente = selectAmbiente.value;
      const elemento = selectElemento.value;
      const placa = selectPlaca.value;
      const estructura = selectEstructura.value;
      const capas = selectCapas.value;
      
      if (!ambiente || !elemento || !placa || !estructura || !capas) {
        clearSelectionResult();
        hideSistemaOutputs();
        return;
      }
      
      // Cargar índices si están vacíos
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      if (systemsIndexBase.length === 0) {
        systemsIndexBase = await loadIndexBase();
      }
      
      // Filtrar sistemas usando systemsIndexEnriched
      const sistemasFiltrados = systemsIndexEnriched.filter(sys => {
        // Filtrar por ambiente
        if (!sys.ambiente_tags || !Array.isArray(sys.ambiente_tags)) return false;
        let matchAmbiente = false;
        if (ambiente === 'seco') {
          matchAmbiente = sys.ambiente_tags.includes('seco');
        } else if (ambiente === 'humedo') {
          matchAmbiente = sys.ambiente_tags.includes('humedo');
        } else if (ambiente === 'semi-intemperie') {
          matchAmbiente = sys.ambiente_tags.includes('semi-intemperie');
        }
        if (!matchAmbiente) return false;
        
        // Filtrar por elemento
        const sysElemento = sys.elemento || sys.tipo;
        if (sysElemento !== elemento) return false;
        
        // Filtrar por placa
        const placaTipos = sys.placa_tipos || (sys.placas ? sys.placas.map(p => p.tipo) : []);
        if (!placaTipos.includes(placa)) return false;
        
        // Filtrar por estructura
        const estructuraTipo = sys.estructura_tipo || sys.estructura;
        if (estructura.includes('TC')) {
          if (estructuraTipo !== 'tc' && !estructuraTipo.startsWith('tc')) return false;
          const perfil = estructura.match(/TC(\d+)/)?.[1];
          if (perfil && sys.perfil_mm != perfil) return false;
        } else if (estructura === 'Ω35') {
          if (estructuraTipo !== 'omega') return false;
          if (sys.perfil_mm !== 35) return false;
        } else if (estructura.includes('Z2')) {
          if (sys.zincado !== 'Z2') return false;
          const perfil = estructura.match(/(\d+)/)?.[1];
          if (perfil && sys.perfil_mm != perfil) return false;
        } else {
          // Montante/rail: formato "70Z1" o "90"
          const perfil = estructura.match(/(\d+)/)?.[1];
          if (perfil && sys.perfil_mm != perfil) return false;
          if (estructura.includes('Z2') && sys.zincado !== 'Z2') return false;
          if (estructura.includes('Z1') && sys.zincado !== 'Z1') return false;
        }
        
        // Filtrar por capas
        if (sys.capas_por_cara != capas) return false;
        
        // Filtrar por modulación (solo 600mm existe actualmente)
        if (sys.modulacion_mm != 600) return false;
        
        return true;
      });
      
      const resultadoContainer = document.getElementById('resultadoContainer');
      const stepResult = document.getElementById('stepResult');
      
      if (sistemasFiltrados.length === 0) {
        resultadoContainer.innerHTML = '<div style="padding: 0.75rem; background: #fee; color: #c33; border-radius: 4px;">No hay sistemas disponibles para esta combinación.</div>';
        stepResult.style.display = 'block';
        sistemaActualMeta = null;
        return;
      }
      
      if (sistemasFiltrados.length === 1) {
        // Auto-selección: buscar meta completa en systemsIndexBase y setear sistemaActualMeta
        const sistemaEnriched = sistemasFiltrados[0];
        const sistemaBase = systemsIndexBase.find(s => s.id === sistemaEnriched.id);
        if (sistemaBase) {
          sistemaActualMeta = sistemaBase;
          resultadoContainer.innerHTML = `<div style="padding: 0.75rem; background: #d4edda; color: #155724; border-radius: 4px; font-weight: 600;">Sistema seleccionado: ${sistemaBase.nombre_comercial || sistemaBase.id}</div>`;
          stepResult.style.display = 'block';
          // Disparar render del sistema seleccionado
          await cargarCSV(sistemaBase.id);
        }
      } else {
        // Mostrar lista de sistemas disponibles
        let html = '<div style="font-weight: 600; margin-bottom: 0.5rem;">Selecciona un sistema:</div>';
        html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
        sistemasFiltrados.forEach(sysEnriched => {
          const sys = systemsIndexBase.find(s => s.id === sysEnriched.id);
          const nombre = sys ? (sys.nombre_comercial || sys.id) : (sysEnriched.nombre_comercial || sysEnriched.id);
          html += `<div style="border: 1px solid #ddd; padding: 0.75rem; border-radius: 4px; background: #fff; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='#fff'" onclick="seleccionarSistemaFinal('${sysEnriched.id}')">
                     <div style="font-weight: 600; margin-bottom: 0.25rem;">${nombre}</div>
                     <button style="padding: 0.5rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-top: 0.5rem;">Seleccionar</button>
                   </div>`;
        });
        html += '</div>';
        resultadoContainer.innerHTML = html;
        stepResult.style.display = 'block';
        sistemaActualMeta = null;
      }
    }
    
    // Función global para seleccionar sistema final
    window.seleccionarSistemaFinal = async function(systemId) {
      await cargarCSV(systemId);
    }
    
    // Actualizar opciones de placa según ambiente y elemento
    async function updatePlacaOptions(ambiente, elemento) {
      const selectPlaca = document.getElementById('selectPlaca');
      const selectEstructura = document.getElementById('selectEstructura');
      const selectCapas = document.getElementById('selectCapas');
      
      if (!selectPlaca) return;
      
      // Cargar índices si están vacíos
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      
      // Filtrar sistemas por ambiente y elemento
      const sistemasFiltrados = systemsIndexEnriched.filter(sys => {
        if (!sys.ambiente_tags || !Array.isArray(sys.ambiente_tags)) return false;
        
        // Filtrar por ambiente
        let matchAmbiente = false;
        if (ambiente === 'seco') {
          matchAmbiente = sys.ambiente_tags.includes('seco');
        } else if (ambiente === 'humedo') {
          matchAmbiente = sys.ambiente_tags.includes('humedo');
        } else if (ambiente === 'semi-intemperie') {
          matchAmbiente = sys.ambiente_tags.includes('semi-intemperie');
        }
        if (!matchAmbiente) return false;
        
        // Filtrar por elemento
        const sysElemento = sys.elemento || sys.tipo;
        return sysElemento === elemento;
      });
      
      // Obtener tipos de placa únicos
      const placasUnicas = new Set();
      sistemasFiltrados.forEach(sys => {
        if (sys.placa_tipos && Array.isArray(sys.placa_tipos)) {
          sys.placa_tipos.forEach(tipo => placasUnicas.add(tipo));
        } else if (sys.placas && Array.isArray(sys.placas)) {
          sys.placas.forEach(p => {
            if (p.tipo) placasUnicas.add(p.tipo);
          });
        }
      });
      
      // Ordenar placas (STD, AQUA, LIGNUM, EXTERNA_LIGHT)
      const ordenPlacas = ['STD', 'AQUA', 'LIGNUM', 'EXTERNA_LIGHT'];
      const placasOrdenadas = Array.from(placasUnicas).sort((a, b) => {
        const idxA = ordenPlacas.indexOf(a);
        const idxB = ordenPlacas.indexOf(b);
        if (idxA === -1 && idxB === -1) return a.localeCompare(b);
        if (idxA === -1) return 1;
        if (idxB === -1) return -1;
        return idxA - idxB;
      });
      
      // Rellenar select de placa
      selectPlaca.innerHTML = '<option value="">Seleccionar...</option>';
      placasOrdenadas.forEach(placa => {
        const option = document.createElement('option');
        option.value = placa;
        option.textContent = placa;
        selectPlaca.appendChild(option);
      });
      
      // Habilitar selectPlaca si hay opciones
      selectPlaca.disabled = placasOrdenadas.length === 0;
      
      // Resetear y deshabilitar selects dependientes
      if (selectEstructura) {
        selectEstructura.innerHTML = '<option value="">Seleccionar...</option>';
        selectEstructura.disabled = true;
      }
      if (selectCapas) {
        selectCapas.innerHTML = '<option value="">Seleccionar...</option>';
        selectCapas.disabled = true;
      }
    }
    
    // Actualizar opciones de estructura según ambiente, elemento y placa
    async function updateEstructuraOptions(ambiente, elemento, placa) {
      const selectEstructura = document.getElementById('selectEstructura');
      const selectCapas = document.getElementById('selectCapas');
      
      if (!selectEstructura) return;
      
      // Cargar índices si están vacíos
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      
      // Filtrar sistemas por ambiente, elemento y placa
      const sistemasFiltrados = systemsIndexEnriched.filter(sys => {
        if (!sys.ambiente_tags || !Array.isArray(sys.ambiente_tags)) return false;
        
        // Filtrar por ambiente
        let matchAmbiente = false;
        if (ambiente === 'seco') {
          matchAmbiente = sys.ambiente_tags.includes('seco');
        } else if (ambiente === 'humedo') {
          matchAmbiente = sys.ambiente_tags.includes('humedo');
        } else if (ambiente === 'semi-intemperie') {
          matchAmbiente = sys.ambiente_tags.includes('semi-intemperie');
        }
        if (!matchAmbiente) return false;
        
        // Filtrar por elemento
        const sysElemento = sys.elemento || sys.tipo;
        if (sysElemento !== elemento) return false;
        
        // Filtrar por placa (debe incluir el tipo de placa seleccionado)
        const placaTipos = sys.placa_tipos || (sys.placas ? sys.placas.map(p => p.tipo) : []);
        return placaTipos.includes(placa);
      });
      
      // Obtener estructuras únicas
      const estructurasUnicas = new Set();
      sistemasFiltrados.forEach(sys => {
        const estructuraTipo = sys.estructura_tipo || sys.estructura;
        if (!estructuraTipo) return;
        
        // Formatear estructura según tipo
        if (estructuraTipo === 'montante_rail') {
          const perfil = sys.perfil_mm;
          const zinc = sys.zincado || '';
          if (perfil) {
            estructurasUnicas.add(`${perfil}${zinc}`);
          }
        } else if (estructuraTipo === 'omega') {
          estructurasUnicas.add('Ω35');
        } else if (estructuraTipo.startsWith('tc')) {
          const perfil = sys.perfil_mm;
          if (perfil) {
            estructurasUnicas.add(`TC${perfil}`);
          }
        } else if (estructuraTipo === 'semi-intemperie') {
          const perfil = sys.perfil_mm;
          if (perfil && sys.zincado === 'Z2') {
            estructurasUnicas.add(`${perfil} Z2`);
          }
        }
      });
      
      // Ordenar estructuras
      const estructurasOrdenadas = Array.from(estructurasUnicas).sort((a, b) => {
        // Extraer números para ordenación numérica
        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
        if (numA !== numB) return numA - numB;
        return a.localeCompare(b);
      });
      
      // Rellenar select de estructura
      selectEstructura.innerHTML = '<option value="">Seleccionar...</option>';
      estructurasOrdenadas.forEach(estructura => {
        const option = document.createElement('option');
        option.value = estructura;
        option.textContent = estructura;
        selectEstructura.appendChild(option);
      });
      
      // Habilitar selectEstructura si hay opciones
      selectEstructura.disabled = estructurasOrdenadas.length === 0;
      
      // Resetear y deshabilitar select dependiente
      if (selectCapas) {
        selectCapas.innerHTML = '<option value="">Seleccionar...</option>';
        selectCapas.disabled = true;
      }
    }
    
    // Actualizar opciones de capas según ambiente, elemento, placa y estructura
    async function updateCapasOptions(ambiente, elemento, placa, estructura) {
      const selectCapas = document.getElementById('selectCapas');
      
      if (!selectCapas) return;
      
      // Cargar índices si están vacíos
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      
      // Filtrar sistemas por ambiente, elemento, placa y estructura
      const sistemasFiltrados = systemsIndexEnriched.filter(sys => {
        if (!sys.ambiente_tags || !Array.isArray(sys.ambiente_tags)) return false;
        
        // Filtrar por ambiente
        let matchAmbiente = false;
        if (ambiente === 'seco') {
          matchAmbiente = sys.ambiente_tags.includes('seco');
        } else if (ambiente === 'humedo') {
          matchAmbiente = sys.ambiente_tags.includes('humedo');
        } else if (ambiente === 'semi-intemperie') {
          matchAmbiente = sys.ambiente_tags.includes('semi-intemperie');
        }
        if (!matchAmbiente) return false;
        
        // Filtrar por elemento
        const sysElemento = sys.elemento || sys.tipo;
        if (sysElemento !== elemento) return false;
        
        // Filtrar por placa
        const placaTipos = sys.placa_tipos || (sys.placas ? sys.placas.map(p => p.tipo) : []);
        if (!placaTipos.includes(placa)) return false;
        
        // Filtrar por estructura
        const estructuraTipo = sys.estructura_tipo || sys.estructura;
        if (estructura.includes('TC')) {
          if (estructuraTipo !== 'tc' && !estructuraTipo.startsWith('tc')) return false;
          const perfil = estructura.match(/TC(\d+)/)?.[1];
          if (perfil && sys.perfil_mm != perfil) return false;
        } else if (estructura === 'Ω35') {
          if (estructuraTipo !== 'omega') return false;
          if (sys.perfil_mm !== 35) return false;
        } else if (estructura.includes('Z2')) {
          if (sys.zincado !== 'Z2') return false;
          const perfil = estructura.match(/(\d+)/)?.[1];
          if (perfil && sys.perfil_mm != perfil) return false;
        } else {
          // Montante/rail: formato "70Z1" o "90"
          const perfil = estructura.match(/(\d+)/)?.[1];
          if (perfil && sys.perfil_mm != perfil) return false;
          if (estructura.includes('Z2') && sys.zincado !== 'Z2') return false;
          if (estructura.includes('Z1') && sys.zincado !== 'Z1') return false;
        }
        
        return true;
      });
      
      // Obtener capas únicas (solo 1 o 2)
      const capasUnicas = new Set();
      sistemasFiltrados.forEach(sys => {
        const capas = sys.capas_por_cara;
        if (capas === 1 || capas === 2) {
          capasUnicas.add(capas);
        }
      });
      
      // Ordenar capas (1, 2)
      const capasOrdenadas = Array.from(capasUnicas).sort((a, b) => a - b);
      
      // Rellenar select de capas
      selectCapas.innerHTML = '<option value="">Seleccionar...</option>';
      capasOrdenadas.forEach(capa => {
        const option = document.createElement('option');
        option.value = capa;
        option.textContent = `${capa} (${capa}+${capa})`;
        selectCapas.appendChild(option);
      });
      
      // Habilitar selectCapas si hay opciones
      selectCapas.disabled = capasOrdenadas.length === 0;
    }
    
    // Inicializar event listeners del flujo
    function initSelectionFlow() {
      if (selectionFlowInitialized) return;
      selectionFlowInitialized = true;
      
      const selectAmbiente = document.getElementById('selectAmbiente');
      const selectElemento = document.getElementById('selectElemento');
      const selectPlaca = document.getElementById('selectPlaca');
      const selectEstructura = document.getElementById('selectEstructura');
      const selectCapas = document.getElementById('selectCapas');
      
      if (!selectAmbiente || !selectElemento || !selectPlaca || !selectEstructura || !selectCapas) {
        return;
      }
      
      // Estado inicial UI
      setStepVisible('step2', false);
      setStepVisible('step3', false);
      setStepVisible('step4', false);
      setStepVisible('step5', false);
      clearSelectionResult();
      hideSistemaOutputs();
      
      // Paso 1: Ambiente
      selectAmbiente.addEventListener('change', async () => {
        const ambiente = selectAmbiente.value;
        clearSelectionResult();
        hideSistemaOutputs();
        setStepVisible('step3', false);
        setStepVisible('step4', false);
        setStepVisible('step5', false);
        if (ambiente) {
          setStepVisible('step2', true);
          await updateElementoOptions(ambiente);
          await filtrarYMostrarSistemas();
        } else {
          setStepVisible('step2', false);
        }
      });
      
      // Paso 2: Elemento
      selectElemento.addEventListener('change', async () => {
        const ambiente = selectAmbiente.value;
        const elemento = selectElemento.value;
        clearSelectionResult();
        hideSistemaOutputs();
        setStepVisible('step4', false);
        setStepVisible('step5', false);
        if (ambiente && elemento) {
          setStepVisible('step3', true);
          await updatePlacaOptions(ambiente, elemento);
          await filtrarYMostrarSistemas();
        } else {
          setStepVisible('step3', false);
        }
      });
      
      // Paso 3: Placa
      selectPlaca.addEventListener('change', async () => {
        const ambiente = selectAmbiente.value;
        const elemento = selectElemento.value;
        const placa = selectPlaca.value;
        clearSelectionResult();
        hideSistemaOutputs();
        setStepVisible('step5', false);
        if (ambiente && elemento && placa) {
          setStepVisible('step4', true);
          await updateEstructuraOptions(ambiente, elemento, placa);
          await filtrarYMostrarSistemas();
        } else {
          setStepVisible('step4', false);
        }
      });
      
      // Paso 4: Estructura/Perfilería
      selectEstructura.addEventListener('change', async () => {
        const ambiente = selectAmbiente.value;
        const elemento = selectElemento.value;
        const placa = selectPlaca.value;
        const estructura = selectEstructura.value;
        clearSelectionResult();
        hideSistemaOutputs();
        if (ambiente && elemento && placa && estructura) {
          setStepVisible('step5', true);
          await updateCapasOptions(ambiente, elemento, placa, estructura);
          await filtrarYMostrarSistemas();
        } else {
          setStepVisible('step5', false);
        }
      });
      
      // Paso 5: Capas
      selectCapas.addEventListener('change', async () => {
        clearSelectionResult();
        hideSistemaOutputs();
        await filtrarYMostrarSistemas();
      });
    }
    
    // ========== FIN FLUJO DE SELECCIÓN ==========

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(',');
      const formato = detectarFormatoCSV(header);
      
      return lines.map(l=>{
        const cols = l.split(',');
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]||'').trim());
        
        // Normalizar formato legacy a nuevo
        if (formato === 'legacy') {
          obj.rendimiento_m2 = obj.coef || obj.rendimiento_m2 || '0';
          obj.precio_catalogo_almeria = obj.precio || obj.precio_catalogo_almeria || '0';
          obj.familia_precio = obj.familia_precio || detectarFamilia(obj.concepto, obj.sku || obj.codigo);
          obj.codigo = obj.codigo || obj.sku || '';
        }
        
        obj._formato = formato;
        return obj;
      });
    }

    async function loadCSV(filename){
      const res = await fetch('sistemas/'+filename);
      if(!res.ok) throw new Error('No se pudo cargar '+filename);
      return await res.text();
    }

    function toNum(x){ return Number(String(x).replace(',','.'))||0; }

    // Renderizar información del sistema (read-only)
    function renderFichaTecnica(meta) {
      const container = document.getElementById('fichaTecnica');
      const content = document.getElementById('fichaTecnicaContent');
      
      if (!meta || !meta.id) {
        container.style.display = 'none';
        return;
      }
      
      const items = [];
      
      // Tipo de sistema
      if (meta.tipo_sistema || meta.tipo) {
        items.push(`<div><strong>Tipo de sistema:</strong> ${meta.tipo_sistema || meta.tipo}</div>`);
      }
      
      // Configuración: capas por cara
      if (meta.capas_por_cara !== undefined && meta.capas_por_cara !== null) {
        items.push(`<div><strong>Configuración:</strong> ${meta.capas_por_cara} placas por cara</div>`);
      }
      
      // Tipo de placa
      if (meta.placa_tipo) {
        items.push(`<div><strong>Tipo de placa:</strong> ${meta.placa_tipo}</div>`);
      } else if (meta.placas && meta.placas.length > 0) {
        const tiposPlaca = [...new Set(meta.placas.map(p => p.tipo))].join('/');
        if (tiposPlaca) {
          items.push(`<div><strong>Tipo de placa:</strong> ${tiposPlaca}</div>`);
        }
      }
      
      // Perfilería: perfil_mm + zincado
      if (meta.perfil_mm !== undefined && meta.perfil_mm !== null) {
        let perfilText = `${meta.perfil_mm} mm`;
        if (meta.zincado) {
          perfilText += ` (${meta.zincado})`;
        }
        items.push(`<div><strong>Perfilería:</strong> ${perfilText}</div>`);
      }
      
      // Altura máxima
      if (meta.hmax_m !== undefined && meta.hmax_m !== null) {
        items.push(`<div><strong>Altura máxima del sistema:</strong> ${meta.hmax_m} m</div>`);
      } else if (meta.Hmax_m !== undefined && meta.Hmax_m !== null) {
        items.push(`<div><strong>Altura máxima del sistema:</strong> ${meta.Hmax_m} m</div>`);
      }
      
      // Uso recomendado
      if (meta.uso_recomendado) {
        items.push(`<div><strong>Uso recomendado:</strong> ${meta.uso_recomendado}</div>`);
      }
      
      if (items.length > 0) {
        content.innerHTML = items.join('');
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }
    
    // Renderizar descripción del sistema
    function renderDescripcionTecnica(meta) {
      const container = document.getElementById('descripcionTecnica');
      const content = document.getElementById('descripcionTecnicaContent');
      
      const descripcionCorta = meta?.descripcion_tecnica_corta;
      const descripcionLarga = meta?.descripcion_sistema || meta?.descripcion_tecnica_pdf;
      
      if (!meta || (!descripcionCorta && !descripcionLarga)) {
        container.style.display = 'none';
        return;
      }
      
      // Mostrar descripción corta primero (si existe), luego la larga
      let htmlContent = '';
      if (descripcionCorta) {
        htmlContent += `<div style="font-weight: 500; margin-bottom: 0.5rem;">${descripcionCorta}</div>`;
      }
      if (descripcionLarga) {
        htmlContent += `<div style="margin-top: ${descripcionCorta ? '0.5' : '0'}rem;">${descripcionLarga}</div>`;
      }
      
      content.innerHTML = htmlContent;
      container.style.display = 'block';
    }

    let proyecto = [];

    async function calcularYMostrar(addToProject = false){
      // Usar sistemaActualMeta si está disponible (flujo paso a paso)
      if (sistemaActualMeta) {
        return await calcularYMostrarConSistema(sistemaActualMeta, addToProject);
      }
      // Fallback: si no hay sistema seleccionado, no hacer nada
      document.getElementById('resumenSistema').style.display = 'none';
      document.getElementById('fichaTecnica').style.display = 'none';
      document.getElementById('descripcionTecnica').style.display = 'none';
      return null;
    }
    

    function renderProyecto(){
      const tbody = document.querySelector('#projTable tbody');
      tbody.innerHTML = '';
      let projTotalVenta = 0;
      
      proyecto.forEach((p, idx)=>{
        const precioVenta = p.ventaM2 || p.ventaPorM2 || (p.precioVentaSistema / p.area) || (p.totalVenta / p.area);
        const totalVenta = p.precioVentaSistema || p.totalVenta || p.total || 0;
        projTotalVenta += totalVenta;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.system}</td>
          <td class="num">${fmtNumber(p.area, 2)}</td>
          <td class="num">${fmtEUR(precioVenta)}</td>
          <td class="num">${fmtEUR(totalVenta)}</td>
          <td>
            <button onclick="eliminarSistema(${idx})" class="btn-small" style="background:#e74c3c" aria-label="Eliminar sistema"><i class="fas fa-trash" aria-hidden="true"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('projTotal').textContent = fmtEUR(projTotalVenta);
    }

    window.eliminarSistema = function(idx){
      proyecto.splice(idx, 1);
      renderProyecto();
    }

    function svgToImageData(svgDataUri, callback) {
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
        const imageData = canvas.toDataURL('image/png', 1.0);
        callback(imageData);
      };
      img.onerror = function() {
        callback(null);
      };
      img.src = svgDataUri;
    }

    function getDescripcionComercial(meta) {
      const tipo = meta.tipo;
      const placa = meta.placa;
      const capas = meta.capas;
      const perfil = meta.perfil;
      
      let desc = '';
      
      if(tipo === 'MURO') {
        if(placa.includes('AQUA')) {
          desc = capas === 1 ? 'Tabique interior hidrófugo · Simple placa' : 'Tabique interior hidrófugo · Doble placa';
        } else if(placa.includes('MIX') || placa.includes('AQ-ST')) {
          desc = 'Tabique interior mixto (hidrófugo/estándar) · Doble placa';
        } else {
          desc = capas === 1 ? 'Tabique interior · Simple placa' : 'Tabique interior · Doble placa';
        }
        desc += ` · Perfilería ${perfil}`;
      } else if(tipo === 'TRASDOSADO') {
        if(meta.perfil.includes('Ω')) {
          desc = placa.includes('AQUA') 
            ? 'Trasdosado semidirecto hidrófugo · Perfil Ω35' 
            : 'Trasdosado semidirecto · Perfil Ω35';
        } else {
          if(placa.includes('AQUA')) {
            desc = capas === 1 ? 'Trasdosado autoportante hidrófugo · Simple placa' : 'Trasdosado autoportante hidrófugo · Doble placa';
          } else {
            desc = capas === 1 ? 'Trasdosado autoportante · Simple placa' : 'Trasdosado autoportante · Doble placa';
          }
          desc += ` · Perfilería ${perfil}`;
        }
      } else if(tipo === 'TECHO') {
        if(placa.includes('AQUA')) {
          desc = `Techo continuo hidrófugo · Perfil ${perfil}`;
        } else {
          desc = `Techo continuo · Perfil ${perfil}`;
        }
        desc += ' · Simple placa';
      } else if(tipo === 'EXTERIOR') {
        desc = `Fachada ventilada · Perfilería ${perfil} · Placa externa`;
      }
      
      return desc || 'Sistema constructivo FassaBortolo';
    }

    async function exportPDF(){
      if(proyecto.length === 0){
        alert('No hay sistemas en el proyecto');
        return;
      }

      // Cargar índice actualizado de sistemas para rehidratar metadata
      if (systemsIndexBase.length === 0) {
        systemsIndexBase = await loadIndexBase();
      }
      const systemsIndex = systemsIndexBase;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
      const date = new Date().toLocaleDateString('es-ES');
      const projectName = document.getElementById('projectName').value || 'Proyecto';
      const total = proyecto.reduce((t,p)=>t+(p.precioVentaSistema || p.totalVenta || p.total || 0),0);

      return new Promise((resolve) => {
        svgToImageData(LOGO_SVG, (logoData) => {
          if(logoData) {
            doc.addImage(logoData, 'PNG', 14, 10, 60, 15);
          }
          
          doc.setFontSize(20);
          doc.setTextColor('#e74c3c');
          doc.text('Presupuesto', 14, logoData ? 28 : 22);
          doc.setFontSize(11);
          doc.setTextColor('#666');
          doc.text(`Proyecto: ${projectName}`, 14, logoData ? 34 : 32);
          doc.text(`Fecha: ${date}`, 14, logoData ? 40 : 38);

          let y = logoData ? 52 : 48;

          // Almacenar datos para tabla resumen final
          const resumenData = [];

          proyecto.forEach((p, idx) => {
            if(y > 240) {
              doc.addPage();
              y = 20;
            }

            const precioPorM2 = p.ventaM2 || (p.precioVentaSistema || 0) / p.area;
            const totalSistema = p.precioVentaSistema || 0;
            const incotermSistema = p.incoterm || 'CIF';
            const sistemaId = p.system || p.meta?.id;
            
            // Rehidratar metadata desde el índice actualizado (no usar meta guardado)
            const metaFresh = systemsIndex.find(s => s.id === sistemaId) || p.meta || {};
            
            // Obtener título PDF desde metadata fresca (fallback a nombre_comercial o name)
            const tituloPdf = metaFresh.titulo_pdf || metaFresh.nombre_comercial || metaFresh.name || sistemaId;
            
            // Guardar para tabla resumen
            resumenData.push({
              sistema: `${sistemaId} — ${tituloPdf}`,
              m2: p.area,
              precioM2: precioPorM2,
              total: totalSistema,
              incoterm: incotermSistema
            });
            
            // Línea separadora
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.5);
            doc.line(14, y, 196, y);
            y += 8;
            
            // Encabezado: Sistema: {id} — {titulo_pdf}
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#2c3e50');
            doc.text(`Sistema: ${sistemaId} — ${tituloPdf}`, 14, y);
            y += 8;
            
            // Bloque "Descripción del sistema" (desde metadata fresca)
            // Prioridad: descripcion_tecnica_corta primero, luego descripcion_sistema como fallback
            const descripcionCorta = metaFresh.descripcion_tecnica_corta || '';
            const descripcionLarga = metaFresh.descripcion_sistema || metaFresh.descripcion_tecnica_pdf || '';
            const descripcionMostrar = descripcionCorta || descripcionLarga;
            
            if (descripcionMostrar && descripcionMostrar.trim()) {
              doc.setFontSize(9);
              doc.setFont(undefined, 'bold');
              doc.setTextColor('#555');
              doc.text('Descripción del sistema:', 14, y);
              y += 5;
              
              doc.setFont(undefined, 'normal');
              const descLines = doc.splitTextToSize(descripcionMostrar, 180);
              doc.text(descLines, 14, y);
              y += descLines.length * 4 + 4;
            }
            
            // Bloque "Datos principales"
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#555');
            doc.text('Datos principales:', 14, y);
            y += 5;
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor('#666');
            const perfilMm = metaFresh.perfil_mm || metaFresh.perfil || p.meta?.perfil_mm || p.meta?.perfil || '—';
            const capasPorCara = metaFresh.capas_por_cara || metaFresh.capas || p.meta?.capas_por_cara || p.meta?.capas || '—';
            const hmax = metaFresh.Hmax_m || metaFresh.hmax || p.meta?.Hmax_m || p.meta?.hmax || '—';
            
            doc.text(`• Superficie: ${fmtNumber(p.area, 2)} m²`, 14, y);
            y += 5;
            doc.text(`• Perfil: ${perfilMm}${typeof perfilMm === 'number' ? ' mm' : ''}`, 14, y);
            y += 5;
            doc.text(`• Capas: ${capasPorCara} por cara`, 14, y);
            y += 5;
            doc.text(`• Hmax: ${typeof hmax === 'number' ? fmtNumber(hmax, 1) : hmax}${typeof hmax === 'number' ? ' m' : ''}`, 14, y);
            y += 8;
            
            // Bloque "Precio"
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#555');
            doc.text('Precio:', 14, y);
            y += 5;
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor('#666');
            doc.text(`• Precio ${incotermSistema} €/m² **: ${fmtEUR(precioPorM2)}`, 14, y);
            y += 5;
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#2c3e50');
            doc.text(`• Importe total sistema **: ${fmtEUR(totalSistema)}`, 14, y);
            y += 12;
          });

          // Línea separadora antes de resumen
          doc.setDrawColor(220, 220, 220);
          doc.setLineWidth(1);
          doc.line(14, y, 196, y);
          y += 10;
          
          // Tabla resumen final
          const primerIncoterm = proyecto.length > 0 && proyecto[0].incoterm ? proyecto[0].incoterm : 'CIF';
          
          if(y > 250) {
            doc.addPage();
            y = 20;
          }
          
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.setTextColor('#2c3e50');
          doc.text('RESUMEN DEL PROYECTO', 14, y);
          y += 8;
          
          // Encabezados de tabla
          doc.setFontSize(9);
          doc.setFont(undefined, 'bold');
          doc.setTextColor('#555');
          doc.text('Sistema', 14, y);
          doc.text('m²', 70, y);
          doc.text(`Precio ${primerIncoterm} €/m²`, 85, y);
          doc.text('Total', 155, y);
          y += 5;
          
          // Línea separadora tabla
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.3);
          doc.line(14, y, 196, y);
          y += 5;
          
          // Filas de tabla
          doc.setFontSize(8);
          doc.setFont(undefined, 'normal');
          doc.setTextColor('#666');
          resumenData.forEach(item => {
            if(y > 270) {
              doc.addPage();
              y = 20;
              // Reimprimir encabezados
              doc.setFontSize(9);
              doc.setFont(undefined, 'bold');
              doc.setTextColor('#555');
              doc.text('Sistema', 14, y);
              doc.text('m²', 70, y);
              doc.text(`Precio ${primerIncoterm} €/m²`, 85, y);
              doc.text('Total', 155, y);
              y += 5;
              doc.setDrawColor(200, 200, 200);
              doc.line(14, y, 196, y);
              y += 5;
              doc.setFontSize(8);
              doc.setFont(undefined, 'normal');
              doc.setTextColor('#666');
            }
            
            const sistemaTexto = doc.splitTextToSize(item.sistema, 50);
            const alturaFila = Math.max(sistemaTexto.length * 4, 5);
            doc.text(sistemaTexto, 14, y + (alturaFila - sistemaTexto.length * 4) / 2);
            doc.text(fmtNumber(item.m2, 2), 70, y);
            doc.text(fmtEUR(item.precioM2), 85, y);
            doc.text(fmtEUR(item.total), 155, y);
            y += alturaFila + 2;
          });
          
          y += 3;
          // Línea separadora antes de total
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.5);
          doc.line(14, y, 196, y);
          y += 6;
          
          // Total proyecto (destacado)
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.setTextColor('#e74c3c');
          doc.text('TOTAL PROYECTO:', 120, y);
          doc.text(fmtEUR(total), 155, y);
          y += 12;
          
          // Nota legal según incoterm
          let notaLegal = '';
          if (primerIncoterm === 'EXW') {
            notaLegal = '** Precio EXW. No incluye transporte ni impuestos.';
          } else if (primerIncoterm === 'FOB') {
            notaLegal = '** Precio FOB. No incluye transporte ni impuestos.';
          } else {
            notaLegal = '** Precio CIF. No incluye impuestos.';
          }
          
          doc.setFontSize(8);
          doc.setFont(undefined, 'normal');
          doc.setTextColor('#666');
          doc.text(notaLegal, 14, y);

          doc.save(`Presupuesto_${projectName.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}.pdf`);
          resolve();
        });
      });
    }

    function exportExcel(){
      if(proyecto.length === 0){
        alert('No hay sistemas en el proyecto');
        return;
      }

      // Validar que todos los sistemas tienen los campos requeridos
      for (const p of proyecto) {
        if (!p.rows || p.rows.length === 0) {
          alert(`Error: El sistema ${p.system} no tiene datos de materiales.`);
          return;
        }
        for (const r of p.rows) {
          if (r.precioCatalogo === undefined || r.dtoDistribuidorPct === undefined || 
              r.precioNeto === undefined || r.importeNeto === undefined) {
            alert(`Error: El sistema ${p.system} tiene datos incompletos. No se puede exportar.`);
            return;
          }
        }
        if (p.costeNetoSistema === undefined || p.costeTotalSistema === undefined || 
            p.precioVentaSistema === undefined) {
          alert(`Error: El sistema ${p.system} no tiene cálculos completos. No se puede exportar.`);
          return;
        }
      }

      const wb = XLSX.utils.book_new();
      const date = new Date().toLocaleDateString('es-ES');
      const projectName = document.getElementById('projectName').value || 'Proyecto';

      // Resumen del proyecto
      const wsResumen = XLSX.utils.aoa_to_sheet([
        ['PROYECTO:', projectName],
        ['FECHA:', date],
        [''],
        ['Sistema','m²','Precio venta/m²','Total €'],
        ...proyecto.map(p => {
          const precioM2 = p.ventaM2 || (p.precioVentaSistema / p.area);
          return [
            p.system,
            p.area,
            precioM2,
            p.precioVentaSistema
          ];
        }),
        [''],
        ['TOTAL PROYECTO', '', '', proyecto.reduce((t,p)=>t+(p.precioVentaSistema || 0),0)]
      ]);
      XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');

      // Detalle por sistema
      proyecto.forEach(p => {
        const incoterm = p.incoterm || 'CIF';
        const logisticaPct = p.logisticaPct || 0;
        const margenPct = p.margenPct || 0;
        const costeNeto = p.costeNetoSistema || 0;
        const costeTotal = p.costeTotalSistema || 0;
        const precioVenta = p.precioVentaSistema || 0;
        const precioM2 = p.ventaM2 || (precioVenta / p.area);

        const ws = XLSX.utils.aoa_to_sheet([
          ['SISTEMA:', p.system],
          ['m²:', p.area],
          ['Desperdicio %:', p.waste || 0],
          ['Descuento placas:', '60%'],
          ['Descuento resto:', '55%'],
          ['Incoterm:', incoterm],
          ['Logística %:', logisticaPct],
          ['Margen %:', margenPct],
          ['Coste neto sistema €:', costeNeto],
          ['Coste total sistema €:', costeTotal],
          ['Precio venta €/m²:', precioM2],
          ['Total sistema €:', precioVenta],
          [''],
          ['Código','Concepto','Unidad','Coef','Cantidad','Precio Cat.','Dto %','Precio Neto','Importe Neto'],
          ...p.rows.map(r => {
            const precioCatalogo = r.precioCatalogo || 0;
            const dtoPct = r.dtoDistribuidorPct || 0;
            const precioNeto = r.precioNeto || 0;
            const rendimiento = r.rendimiento || r.rendimiento_m2 || 0;
            const qty = r.qty || 0;
            const importeNeto = r.importeNeto || 0;
            return [
              r.codigo || r.sku || '',
              r.concepto || '',
              r.unidad || '',
              rendimiento,
              qty,
              precioCatalogo,
              dtoPct,
              precioNeto,
              importeNeto
            ];
          }),
          [''],
          ['COSTE NETO SISTEMA', '', '', '', '', '', '', '', costeNeto],
          ['COSTE TOTAL SISTEMA', '', '', '', '', '', '', '', costeTotal],
          ['PRECIO VENTA SISTEMA', '', '', '', '', '', '', '', precioVenta]
        ]);
        XLSX.utils.book_append_sheet(wb, ws, p.system.slice(0,31));
      });

      XLSX.writeFile(wb, `Proyecto_${projectName.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}.xlsx`);
    }

    (async()=>{
      // Cargar sistemas index (enriquecido para filtrado, base para CSV)
      if (systemsIndexEnriched.length === 0) {
        systemsIndexEnriched = await loadIndexEnriched();
      }
      if (systemsIndexBase.length === 0) {
        systemsIndexBase = await loadIndexBase();
      }

      document.getElementById('addBtn').addEventListener('click', async()=>{
        await calcularYMostrar(true);
      });

      document.getElementById('pdfBtn').addEventListener('click', exportPDF);
      document.getElementById('excelBtn').addEventListener('click', exportExcel);
      
      // Inicializar flujo de selección paso a paso
      initSelectionFlow();
      
      // Recálculo automático en tiempo real
      const inputsReactivos = ['area', 'waste', 'logisticaPct', 'margenPct', 'incoterm'];
      inputsReactivos.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', async() => await calcularYMostrar(false));
          el.addEventListener('change', async() => await calcularYMostrar(false));
        }
      });
      
      renderProyecto();
    })();
  </script>
</body>
</html>
