<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Proyecto – AriasGroupCaribe SRL</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{--rojo:#e74c3c;--gris:#2c3e50;--light:#ecf0f1}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--light);color:#333}
    .header{background:var(--gris);color:#fff;padding:14px 24px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10}
    .header .logo{font-size:1.4rem;font-weight:800;color:var(--rojo)}
    .header .back{color:#fff;text-decoration:none;margin-left:auto}
    .container{max-width:1200px;margin:24px auto;padding:0 24px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08);padding:24px;margin-bottom:24px}
    h3{margin-top:0;color:var(--gris);border-bottom:2px solid var(--rojo);padding-bottom:8px;margin-bottom:16px}
    .row{display:flex;gap:18px;flex-wrap:wrap;align-items:end}
    label{display:flex;flex-direction:column;font-size:.9rem;gap:6px;flex:1 1 220px}
    input,select{padding:10px 12px;font-size:14px;border:1px solid #ccc;border-radius:8px}
    button{padding:10px 16px;border:0;border-radius:8px;background:var(--rojo);color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
    button:hover{background:#c0392b}
    .meta{display:flex;gap:18px;flex-wrap:wrap;margin-top:12px}
    .meta .item{background:var(--light);border-radius:8px;padding:10px 14px;font-size:.85rem;color:#555}
    table{width:100%;border-collapse:collapse;margin-top:18px;font-size:.9rem}
    th,td{border-bottom:1px solid #eee;padding:10px 8px;text-align:left}
    th{font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;color:#666}
    .num{font-variant-numeric:tabular-nums}
    .totals{background:var(--gris);color:#fff;border-radius:8px;padding:14px 18px;margin-top:18px;display:flex;gap:24px;flex-wrap:wrap}
    .totals .lbl{font-size:.75rem;opacity:.9}
    .totals .val{font-size:1.3rem;font-weight:700}
    .actions{margin-top:18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    #fileInput{display:none}
    .muted{color:#7f8c8d;font-size:.8rem}
    #projTable{margin-top:16px}
    #projTable th{background:var(--rojo);color:#fff}
    .btn-small{padding:4px 8px;font-size:12px;margin:0 2px}
    .table-wrapper{overflow-x:auto;margin-top:16px;-webkit-overflow-scrolling:touch}
    
    /* Responsive - Móvil */
    @media (max-width: 768px) {
      .container{padding:0 16px;margin:16px auto}
      .card{padding:16px;margin-bottom:16px}
      .header{padding:12px 16px}
      .header .logo{font-size:1.1rem}
      .header .back{font-size:.85rem}
      h3{font-size:1.1rem;padding-bottom:6px;margin-bottom:12px}
      .row{gap:12px}
      label{flex:1 1 100%}
      input,select{font-size:16px;padding:12px}
      button{width:100%;padding:12px;font-size:16px;margin-top:8px}
      #addBtn{width:100%}
      .meta{gap:8px}
      .meta .item{font-size:.8rem;padding:8px 10px}
      table{font-size:.8rem;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
      th,td{padding:8px 6px;white-space:nowrap}
      th{font-size:.7rem}
      .totals{padding:12px 16px;flex-direction:column;gap:8px;text-align:center}
      .totals .val{font-size:1.5rem}
      .actions{flex-direction:column}
      .actions button{width:100%}
      .muted{font-size:.75rem;text-align:center}
    }
    
    /* Responsive - Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
      .container{padding:0 20px}
      .card{padding:20px}
      label{flex:1 1 calc(50% - 9px)}
    }
  </style>
</head>
<body>
  <header class="header">
    <i class="fas fa-project-diagram"></i>
    <div class="logo">AriasGroupCaribe SRL</div>
    <a class="back" href="index.html"><i class="fas fa-arrow-left"></i> Volver</a>
  </header>

  <div class="container">
    <!-- Nombre del Proyecto -->
    <div class="card">
      <h3>Proyecto</h3>
      <div class="row">
        <label style="flex:1 1 100%">
          Nombre del Proyecto
          <input id="projectName" type="text" placeholder="Ej: Edificio Residencial Calle Mayor" />
        </label>
      </div>
    </div>

    <!-- Añadir Sistema -->
    <div class="card">
      <h3>Añadir Sistema al Proyecto</h3>
      <div class="row">
        <label>
          Sistema FassaBortolo
          <select id="systemSelect"></select>
        </label>
        <label>
          m² (superficie)
          <input id="area" type="number" step="0.01" value="100" />
        </label>
        <label>
          Desperdicio %
          <input id="waste" type="number" step="0.1" value="5" />
        </label>
        <label>
          Descuento %
          <input id="discount" type="number" step="0.1" value="0" />
        </label>
        <button id="addBtn"><i class="fas fa-plus"></i> Añadir</button>
      </div>
      <div class="meta" id="metaBox"></div>
      
      <div class="table-wrapper">
        <table id="tbl">
          <thead>
            <tr>
              <th>SKU</th><th>Concepto</th><th>Unidad</th><th>Precio</th><th>Coef</th><th>Cantidad</th><th>Importe</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Proyecto Acumulado -->
    <div class="card">
      <h3>Proyecto Acumulado</h3>
      <div class="table-wrapper">
        <table id="projTable">
          <thead>
            <tr>
              <th>Sistema</th><th>m²</th><th>Precio/m²</th><th>Total €</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="totals">
        <div><div class="lbl">Total Proyecto</div><div class="val" id="projTotal">—</div></div>
      </div>
    </div>

    <!-- Exportaciones -->
    <div class="card">
      <h3>Exportar</h3>
      <div class="actions">
        <button id="pdfBtn" style="background:#e74c3c"><i class="fas fa-file-pdf"></i> PDF (Cliente)</button>
        <button id="excelBtn" style="background:#27ae60"><i class="fas fa-file-excel"></i> Excel (Control Interno)</button>
      </div>
      <div class="muted">
        <strong>PDF:</strong> Resumen para cliente (sistemas, materiales, rendimiento, precio/m², total)<br>
        <strong>Excel:</strong> Desglose completo para control interno
      </div>
    </div>
  </div>

  <!-- Librerías CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const EUR = n => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n||0);

    async function loadIndex(){
      const res = await fetch('sistemas/sistemas-index.json');
      const idx = await res.json();
      return idx.systems || [];
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(',');
      return lines.map(l=>{
        const cols = l.split(',');
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]||'').trim());
        return obj;
      });
    }

    async function loadCSV(filename){
      const res = await fetch('sistemas/'+filename);
      if(!res.ok) throw new Error('No se pudo cargar '+filename);
      return await res.text();
    }

    function toNum(x){ return Number(String(x).replace(',','.'))||0; }

    let proyecto = []; // [{system,area,waste,discount,total,rows,meta}, ...]

    async function calcularYMostrar(){
      const area = toNum(document.getElementById('area').value);
      const waste = toNum(document.getElementById('waste').value);
      const discount = toNum(document.getElementById('discount').value);
      const opt = document.getElementById('systemSelect').selectedOptions[0];
      if(!opt) return null;
      const meta = JSON.parse(opt.dataset.meta);

      document.getElementById('metaBox').innerHTML = `
        <div class="item"><strong>Sistema:</strong> ${meta.id}</div>
        <div class="item"><strong>Perfil:</strong> ${meta.perfil}</div>
        <div class="item"><strong>Placa:</strong> ${meta.placa}</div>
        <div class="item"><strong>Capas:</strong> ${meta.capas} por cara</div>
        <div class="item"><strong>Hmax:</strong> ${meta.Hmax_m} m</div>
      `;

      const csvText = await loadCSV(meta.csv);
      const rows = parseCSV(csvText);
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      let totalMat = 0;
      const rowsData = [];

      for(const r of rows){
        const precio = toNum(r.precio);
        const coef = toNum(r.coef);
        const qty = area * coef * (1 + waste/100);
        const imp = qty * precio;
        totalMat += imp;

        rowsData.push({...r, precio, coef, qty, imp});

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="num">${r.sku}</td>
          <td>${r.concepto}</td>
          <td class="num">${r.unidad}</td>
          <td class="num">${EUR(precio)}</td>
          <td class="num">${coef}</td>
          <td class="num">${qty.toFixed(3)}</td>
          <td class="num">${EUR(imp)}</td>
        `;
        tbody.appendChild(tr);
      }

      const totalConDescuento = totalMat * (1 - discount/100);

      return {
        system: meta.id,
        systemName: opt.textContent,
        area,
        waste,
        discount,
        total: totalConDescuento,
        totalSinDescuento: totalMat,
        rows: rowsData,
        meta
      };
    }

    function renderProyecto(){
      const tbody = document.querySelector('#projTable tbody');
      tbody.innerHTML = '';
      let projTotal = 0;
      
      proyecto.forEach((p, idx)=>{
        projTotal += p.total;
        const precioPorM2 = p.total / p.area;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.system}</td>
          <td class="num">${p.area.toFixed(2)}</td>
          <td class="num">${EUR(precioPorM2)}</td>
          <td class="num">${EUR(p.total)}</td>
          <td>
            <button onclick="eliminarSistema(${idx})" class="btn-small" style="background:#e74c3c"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('projTotal').textContent = EUR(projTotal);
    }

    window.eliminarSistema = function(idx){
      proyecto.splice(idx, 1);
      renderProyecto();
    }

    function svgToImageData(svgText, callback) {
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      const DOMURL = window.URL || window.webkitURL || window;
      const img = new Image();
      const svg = new Blob([svgText], {type: 'image/svg+xml;charset=utf-8'});
      const url = DOMURL.createObjectURL(svg);
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
        DOMURL.revokeObjectURL(url);
        const imageData = canvas.toDataURL('image/png', 1.0);
        callback(imageData);
      };
      img.onerror = function() {
        DOMURL.revokeObjectURL(url);
        callback(null);
      };
      img.src = url;
    }

    async function exportPDF(){
      if(proyecto.length === 0){
        alert('No hay sistemas en el proyecto');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
      const date = new Date().toLocaleDateString('es-ES');
      const projectName = document.getElementById('projectName').value || 'Proyecto';
      const total = proyecto.reduce((t,p)=>t+p.total,0);

      // Logo SVG
      const svgText = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 200" width="800" height="200">
  <text x="20" y="110" font-family="Arial, sans-serif" font-size="90" font-weight="900" fill="#e74c3c">ARIAS</text>
  <text x="20" y="160" font-family="Arial, sans-serif" font-size="38" font-weight="300" fill="#2c3e50">GROUP Caribe SRL</text>
</svg>`;

      // Convertir SVG a imagen y añadir al PDF
      return new Promise((resolve) => {
        svgToImageData(svgText, (logoData) => {
          if(logoData) {
            doc.addImage(logoData, 'PNG', 14, 10, 60, 15);
          }
          
          // Encabezado (ajustado para dejar espacio al logo)
          doc.setFontSize(18);
          doc.setTextColor('#e74c3c');
          doc.text('Presupuesto', 14, logoData ? 28 : 22);
          doc.setFontSize(11);
          doc.setTextColor('#333');
          doc.text(`Proyecto: ${projectName}`, 14, logoData ? 34 : 32);
          doc.text(`Fecha: ${date}`, 14, logoData ? 40 : 38);

          let y = logoData ? 52 : 48;

      // Resumen por sistema
      proyecto.forEach((p, idx) => {
        if(y > 250) {
          doc.addPage();
          y = 20;
        }

        const precioPorM2 = p.total / p.area;
        
        doc.setFontSize(12);
        doc.setTextColor('#2c3e50');
        doc.text(`${p.system} (${p.area.toFixed(2)} m²)`,14,y);
        y += 8;

        // Tabla de materiales del sistema
        const body = p.rows.map(r => [
          r.concepto,
          r.unidad,
          r.coef,
          EUR(r.precio)
        ]);

        doc.autoTable({
          head:[['Material','Unidad','Rendimiento','Precio Unit.']],
          body:body,
          startY:y,
          styles:{fontSize:9},
          headStyles:{fillColor:'#2c3e50',textColor:'#fff'},
          alternateRowStyles:{fillColor:'#f8f9fa'},
          columnStyles: {
            2: {halign: 'right'},
            3: {halign: 'right'}
          }
        });

        y = doc.lastAutoTable.finalY + 10;
        
        // Total del sistema
        doc.setFontSize(10);
        doc.text(`Total ${p.system}: ${EUR(p.total)} (${EUR(precioPorM2)}/m²)`,14,y);
        y += 12;
      });

      // Total proyecto
      y += 5;
      doc.setFontSize(14);
      doc.setTextColor('#e74c3c');
      doc.text(`TOTAL PROYECTO: ${EUR(total)}`,14,y);

      doc.save(`Presupuesto_${projectName.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}.pdf`);
          resolve();
        });
      });
    }

    function exportExcel(){
      if(proyecto.length === 0){
        alert('No hay sistemas en el proyecto');
        return;
      }

      const wb = XLSX.utils.book_new();
      const date = new Date().toLocaleDateString('es-ES');
      const projectName = document.getElementById('projectName').value || 'Proyecto';

      // Hoja resumen
      const wsResumen = XLSX.utils.aoa_to_sheet([
        ['PROYECTO:', projectName],
        ['FECHA:', date],
        [''],
        ['Sistema','m²','Precio/m²','Total €'],
        ...proyecto.map(p => [
          p.system,
          p.area.toFixed(2),
          (p.total / p.area).toFixed(2),
          p.total
        ]),
        [''],
        ['TOTAL PROYECTO', '', '', proyecto.reduce((t,p)=>t+p.total,0)]
      ]);
      XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');

      // Hoja por cada sistema con desglose completo
      proyecto.forEach(p => {
        const ws = XLSX.utils.aoa_to_sheet([
          ['SISTEMA:', p.system],
          ['m²:', p.area],
          ['Desperdicio:', p.waste + '%'],
          ['Descuento:', p.discount + '%'],
          [''],
          ['SKU','Concepto','Unidad','Precio','Coef','Cantidad','Importe'],
          ...p.rows.map(r => [
            r.sku,
            r.concepto,
            r.unidad,
            r.precio,
            r.coef,
            r.qty.toFixed(3),
            r.imp
          ]),
          [''],
          ['TOTAL SISTEMA', '', '', '', '', '', p.total]
        ]);
        XLSX.utils.book_append_sheet(wb, ws, p.system.slice(0,31));
      });

      XLSX.writeFile(wb, `Proyecto_${projectName.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}.xlsx`);
    }

    (async()=>{
      const systems = await loadIndex();
      const sel = document.getElementById('systemSelect');
      systems.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.csv;
        opt.textContent = `${s.id} | ${s.tipo} | ${s.perfil} | ${s.placa} | ${s.capas} capa(s)/cara`;
        opt.dataset.meta = JSON.stringify(s);
        sel.appendChild(opt);
      });

      document.getElementById('addBtn').addEventListener('click', async()=>{
        const item = await calcularYMostrar();
        if(item){
          proyecto.push(item);
          renderProyecto();
        }
      });

      document.getElementById('pdfBtn').addEventListener('click', exportPDF);
      document.getElementById('excelBtn').addEventListener('click', exportExcel);
      renderProyecto();
    })();
  </script>
</body>
</html>
