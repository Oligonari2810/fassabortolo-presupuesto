<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Presupuesto – FassaBortolo Caribe</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f8f9fa;color:#333}
    .header{background:#2c3e50;color:#fff;padding:14px 24px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10}
    .header .logo{font-size:1.4rem;font-weight:800}
    .header .logo span{color:#e74c3c}
    .header .back{color:#fff;text-decoration:none;margin-left:auto}
    .container{max-width:1100px;margin:24px auto;padding:0 24px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08);padding:24px;margin-bottom:24px}
    .row{display:flex;gap:18px;flex-wrap:wrap;align-items:end}
    label{display:flex;flex-direction:column;font-size:.9rem;gap:6px;flex:1 1 220px}
    input,select{padding:10px 12px;font-size:14px;border:1px solid #ccc;border-radius:8px}
    button{padding:10px 16px;border:0;border-radius:8px;background:#e74c3c;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
    button:hover{background:#c0392b}
    .meta{display:flex;gap:18px;flex-wrap:wrap;margin-top:12px}
    .meta .item{background:#f8f9fa;border-radius:8px;padding:10px 14px;font-size:.85rem;color:#555}
    table{width:100%;border-collapse:collapse;margin-top:18px;font-size:.9rem}
    th,td{border-bottom:1px solid #eee;padding:10px 8px;text-align:left}
    th{font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;color:#666}
    .num{font-variant-numeric:tabular-nums}
    .totals{background:#2c3e50;color:#fff;border-radius:8px;padding:14px 18px;margin-top:18px;display:flex;gap:24px;flex-wrap:wrap}
    .totals .lbl{font-size:.75rem;opacity:.9}
    .totals .val{font-size:1.3rem;font-weight:700}
    .actions{margin-top:18px;display:flex;gap:12px;flex-wrap:wrap}
    #fileInput{display:none}
    .muted{color:#7f8c8d;font-size:.8rem}
    @media(max-width:600px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header class="header">
    <i class="fas fa-calculator"></i>
    <div class="logo">Fassa<span>Bortolo</span> Caribe</div>
    <a class="back" href="index.html"><i class="fas fa-arrow-left"></i> Volver</a>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <label>
          Sistema
          <select id="systemSelect"></select>
        </label>
        <label>
          m² (superficie)
          <input id="area" type="number" step="0.01" value="100" />
        </label>
        <label>
          Desperdicio %
          <input id="waste" type="number" step="0.1" value="5" />
        </label>
        <label>
          Descuento %
          <input id="discount" type="number" step="0.1" value="0" />
        </label>
        <button id="calcBtn">Calcular</button>
      </div>

      <div class="meta" id="metaBox"></div>

      <table id="tbl">
        <thead>
          <tr>
            <th>SKU</th><th>Concepto</th><th>Unidad</th><th>Precio</th><th>Coef</th><th>Cantidad</th><th>Importe</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="totals">
        <div><div class="lbl">Total materiales</div><div class="val" id="totalMat">—</div></div>
        <div><div class="lbl">Descuento</div><div class="val" id="totalDisc">—</div></div>
        <div><div class="lbl">TOTAL</div><div class="val" id="grandTotal">—</div></div>
      </div>

      <div class="actions">
        <button id="pdfBtn"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
        <label for="fileInput" class="button" style="cursor:pointer"><i class="fas fa-upload"></i> Cargar Excel</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      </div>
      <div class="muted">Formato Excel: columna "Area_m2" con las superficies por habitación.</div>
    </div>
  </div>

  <!-- Librerías desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const EUR = n => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n||0);

    async function loadIndex(){
      const res = await fetch('sistemas/sistemas-index.json');
      const idx = await res.json();
      return idx.systems || [];
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(',');
      return lines.map(l=>{
        const cols = l.split(',');
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]||'').trim());
        return obj;
      });
    }

    async function loadCSV(filename){
      const res = await fetch('sistemas/'+filename);
      if(!res.ok) throw new Error('No se pudo cargar '+filename);
      return await res.text();
    }

    function toNum(x){ return Number(String(x).replace(',','.'))||0; }

    async function calculate(){
      const area = toNum(document.getElementById('area').value);
      const waste = toNum(document.getElementById('waste').value);
      const discount = toNum(document.getElementById('discount').value);
      const opt = document.getElementById('systemSelect').selectedOptions[0];
      if(!opt) return;
      const meta = JSON.parse(opt.dataset.meta);
      document.getElementById('metaBox').innerHTML = `
        <div class="item"><strong>Sistema:</strong> ${meta.id}</div>
        <div class="item"><strong>Perfil:</strong> ${meta.perfil}</div>
        <div class="item"><strong>Placa:</strong> ${meta.placa}</div>
        <div class="item"><strong>Capas:</strong> ${meta.capas}</div>
        <div class="item"><strong>Hmax:</strong> ${meta.Hmax_m} m</div>
      `;

      const csvText = await loadCSV(meta.csv);
      const rows = parseCSV(csvText);
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      let totalMat = 0;

      for(const r of rows){
        const precio = toNum(r.precio);
        const coef = toNum(r.coef);
        const qty = area * coef * (1 + waste/100);
        const imp = qty * precio;
        totalMat += imp;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="num">${r.sku}</td>
          <td>${r.concepto}</td>
          <td class="num">${r.unidad}</td>
          <td class="num">${EUR(precio)}</td>
          <td class="num">${coef}</td>
          <td class="num">${qty.toFixed(3)}</td>
          <td class="num">${EUR(imp)}</td>
        `;
        tbody.appendChild(tr);
      }

      const disc = totalMat * (discount/100);
      const grand = totalMat - disc;

      document.getElementById('totalMat').textContent = EUR(totalMat);
      document.getElementById('totalDisc').textContent = '- ' + EUR(disc);
      document.getElementById('grandTotal').textContent = EUR(grand);
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
      const logo = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='; // 1x1 px blanco → reemplaza por logo real base64
      const total = document.getElementById('grandTotal').textContent;
      const sys = document.getElementById('systemSelect').selectedOptions[0].text;
      const area = document.getElementById('area').value;
      const date = new Date().toLocaleDateString('es-ES');

      doc.setFontSize(18);
      doc.setTextColor('#2c3e50');
      doc.text('Presupuesto FassaBortolo Caribe',14,22);
      doc.setFontSize(11);
      doc.text(`Sistema: ${sys}`,14,32);
      doc.text(`Superficie: ${area} m²`,14,38);
      doc.text(`Fecha: ${date}`,14,44);

      const body = Array.from(document.querySelectorAll('#tbl tbody tr')).map(tr=>{
        const c = tr.children;
        return [c[0].textContent,c[1].textContent,c[2].textContent,c[3].textContent,c[4].textContent,c[5].textContent,c[6].textContent];
      });

      doc.autoTable({
        head:[['SKU','Concepto','Unidad','Precio','Coef','Cantidad','Importe']],
        body:body,
        startY:52,
        styles:{fontSize:9},
        headStyles:{fillColor:'#2c3e50',textColor:'#fff'},
        alternateRowStyles:{fillColor:'#f8f9fa'}
      });

      const finalY = doc.lastAutoTable.finalY + 12;
      doc.setFontSize(12);
      doc.text(`TOTAL: ${total}`,14,finalY);
      doc.save(`Presupuesto_Fassa_${date.replace(/\//g,'-')}.pdf`);
    }

    async function loadExcel(e){
      const file = e.target.files[0];
      if(!file) return;
      const arrayBuffer = await file.arrayBuffer();
      const wb = XLSX.read(arrayBuffer, {type: 'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws);
      let total = 0;
      data.forEach(r=> total += toNum(r.Area_m2)||0);
      document.getElementById('area').value = total.toFixed(2);
      await calculate();
    }

    (async()=>{
      const systems = await loadIndex();
      const sel = document.getElementById('systemSelect');
      systems.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.csv;
        opt.textContent = `${s.id} | ${s.tipo} | ${s.perfil} | ${s.placa} | ${s.capas} capa(s)`;
        opt.dataset.meta = JSON.stringify(s);
        sel.appendChild(opt);
      });
      document.getElementById('calcBtn').addEventListener('click', calculate);
      document.getElementById('pdfBtn').addEventListener('click', exportPDF);
      document.getElementById('fileInput').addEventListener('change', loadExcel);
      await calculate();
    })();
  </script>
</body>
</html>
