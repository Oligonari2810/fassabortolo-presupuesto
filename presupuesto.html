<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
  <meta name="theme-color" content="#2c3e50" />
  <title>Proyecto – AriasGroupCaribe SRL</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --rojo:#e74c3c;
      --gris:#2c3e50;
      --light:#ecf0f1;
      --font-base:16px;
      --space-xs:0.5rem;
      --space-sm:0.75rem;
      --space-md:1rem;
      --space-lg:1.5rem;
      --space-xl:2rem;
      --tap-target:3rem;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0;
      background:var(--light);
      color:#333;
      font-size:var(--font-base);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .header{
      background:var(--gris);
      color:#fff;
      padding:var(--space-sm) var(--space-md);
      display:flex;
      align-items:center;
      gap:var(--space-sm);
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .header .logo{
      font-size:1.125rem;
      font-weight:800;
      color:var(--rojo);
      flex:1;
      min-width:0;
    }
    .header .back{
      color:#fff;
      text-decoration:none;
      display:flex;
      align-items:center;
      gap:var(--space-xs);
      padding:var(--space-xs);
      min-height:var(--tap-target);
      min-width:var(--tap-target);
      justify-content:center;
      border-radius:0.5rem;
      transition:background-color 0.2s;
    }
    .header .back:active{background-color:rgba(255,255,255,.1)}
    .container{
      max-width:75rem;
      margin:0 auto;
      padding:var(--space-md);
    }
    .card{
      background:#fff;
      border-radius:0.75rem;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      padding:var(--space-md);
      margin-bottom:var(--space-md);
    }
    h3{
      margin:0 0 var(--space-md) 0;
      color:var(--gris);
      border-bottom:2px solid var(--rojo);
      padding-bottom:var(--space-xs);
      font-size:1.125rem;
      font-weight:700;
    }
    .row{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
    }
    label{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
      font-size:0.875rem;
      width:100%;
    }
    input[type="text"],
    input[type="number"],
    select{
      width:100%;
      max-width:100%;
      padding:var(--space-md);
      font-size:var(--font-base);
      border:1px solid #ccc;
      border-radius:0.5rem;
      background:#fff;
      min-height:var(--tap-target);
      -webkit-appearance:none;
      appearance:none;
    }
    input:focus,select:focus{
      outline:2px solid var(--rojo);
      outline-offset:2px;
      border-color:var(--rojo);
    }
    select{
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 1rem center;
      padding-right:2.5rem;
      word-break:break-word;
    }
    select option{word-break:break-word}
    button{
      width:100%;
      padding:var(--space-md);
      border:0;
      border-radius:0.5rem;
      background:var(--rojo);
      color:#fff;
      font-size:var(--font-base);
      font-weight:600;
      cursor:pointer;
      min-height:var(--tap-target);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:var(--space-xs);
      transition:background-color 0.2s,transform 0.1s;
      position:relative;
      overflow:hidden;
    }
    button:active{
      background:#c0392b;
      transform:scale(0.98);
    }
    button:active::after{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,.3);
      transform:translate(-50%,-50%);
      animation:ripple 0.4s ease-out;
    }
    @keyframes ripple{
      to{width:200px;height:200px;opacity:0}
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-sm);
      margin-top:var(--space-md);
    }
    .meta .item{
      background:var(--light);
      border-radius:0.5rem;
      padding:var(--space-xs) var(--space-sm);
      font-size:0.8125rem;
      color:#555;
    }
    .table-wrapper{
      overflow-x:auto;
      margin-top:var(--space-md);
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
    }
    .table-wrapper::-webkit-scrollbar{
      height:0.5rem;
    }
    .table-wrapper::-webkit-scrollbar-thumb{
      background:#ccc;
      border-radius:0.25rem;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.875rem;
      min-width:600px;
    }
    th,td{
      border-bottom:1px solid #eee;
      padding:var(--space-sm) var(--space-xs);
      text-align:left;
      white-space:nowrap;
    }
    th{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#666;
      font-weight:600;
      background:#f8f9fa;
      position:sticky;
      top:0;
      z-index:1;
    }
    .num{
      font-variant-numeric:tabular-nums;
      text-align:right;
    }
    .totals{
      background:var(--gris);
      color:#fff;
      border-radius:0.5rem;
      padding:var(--space-md);
      margin-top:var(--space-md);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      text-align:center;
      position:sticky;
      bottom:0;
      z-index:10;
      box-shadow:0 -2px 8px rgba(0,0,0,.1);
    }
    .totals .lbl{
      font-size:0.75rem;
      opacity:.9;
    }
    .totals .val{
      font-size:1.5rem;
      font-weight:700;
    }
    .actions{
      margin-top:var(--space-md);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .actions button{
      width:100%;
    }
    .btn-icon-only .btn-label{
      display:none;
    }
    .btn-small{
      padding:var(--space-xs);
      font-size:0.75rem;
      min-height:2.5rem;
      min-width:2.5rem;
      width:auto;
    }
    .muted{
      color:#7f8c8d;
      font-size:0.75rem;
      margin-top:var(--space-sm);
      line-height:1.6;
    }
    #projTable th{
      background:var(--rojo);
      color:#fff;
    }
    #fileInput{display:none}
    @media (min-width:48rem){
      .container{padding:var(--space-lg)}
      .card{padding:var(--space-lg);margin-bottom:var(--space-lg)}
      .header{padding:var(--space-md) var(--space-lg)}
      .header .logo{font-size:1.375rem}
      h3{font-size:1.25rem;margin-bottom:var(--space-lg)}
      .row{
        flex-direction:row;
        flex-wrap:wrap;
        gap:var(--space-md);
        align-items:flex-end;
      }
      label{
        flex:1 1 auto;
        min-width:0;
      }
      input[type="text"],
      input[type="number"],
      select{
        max-width:7.5rem;
      }
      label[style*="flex:1 1 100%"] input{
        max-width:100%;
      }
      button{
        width:auto;
        padding:var(--space-sm) var(--space-md);
        min-width:auto;
      }
      .meta{gap:var(--space-md)}
      .meta .item{font-size:0.875rem;padding:var(--space-xs) var(--space-sm)}
      table{font-size:0.9375rem;min-width:auto}
      th,td{padding:var(--space-sm) var(--space-xs)}
      th{font-size:0.8125rem}
      .totals{
        flex-direction:row;
        gap:var(--space-xl);
        text-align:left;
        position:relative;
        box-shadow:none;
      }
      .totals .val{font-size:1.3125rem}
      .actions{
        flex-direction:row;
        gap:var(--space-md);
      }
      .actions button{width:auto;flex:1}
      .btn-icon-only .btn-label{display:inline}
      .muted{text-align:left}
    }
    @media (min-width:64rem){
      .container{max-width:75rem}
      .card{padding:var(--space-xl)}
      h3{font-size:1.5rem}
      .row{gap:var(--space-lg)}
      label{flex:1 1 220px}
      input[type="text"],
      input[type="number"],
      select{max-width:7.5rem}
      table{font-size:0.9375rem}
    }
  </style>
</head>
<body>
  <header class="header">
    <i class="fas fa-project-diagram" aria-hidden="true"></i>
    <div class="logo">AriasGroupCaribe SRL</div>
    <a class="back" href="index.html" aria-label="Volver al inicio"><i class="fas fa-arrow-left" aria-hidden="true"></i> <span>Volver</span></a>
  </header>

  <div class="container">
    <div class="card">
      <h3>Proyecto</h3>
      <div class="row">
        <label style="flex:1 1 100%">
          Nombre del Proyecto
          <input id="projectName" type="text" placeholder="Ej: Edificio Residencial Calle Mayor" />
        </label>
      </div>
    </div>

    <div class="card">
      <h3>Añadir Sistema al Proyecto</h3>
      <div class="row">
        <label>
          Sistema FassaBortolo
          <select id="systemSelect"></select>
        </label>
        <label>
          m² (superficie)
          <input id="area" type="number" step="0.01" value="100" />
        </label>
        <label>
          Desperdicio %
          <input id="waste" type="number" step="0.1" value="5" />
        </label>
        <label>
          Descuento %
          <input id="discount" type="number" step="0.1" value="0" />
        </label>
        <button id="addBtn"><i class="fas fa-plus" aria-hidden="true"></i> Añadir</button>
      </div>
      <div class="meta" id="metaBox"></div>
      
      <div class="table-wrapper">
        <table id="tbl">
          <thead>
            <tr>
              <th>SKU</th><th>Concepto</th><th>Unidad</th><th>Precio</th><th>Coef</th><th>Cantidad</th><th>Importe</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Proyecto Acumulado</h3>
      <div class="table-wrapper">
        <table id="projTable">
          <thead>
            <tr>
              <th>Sistema</th><th>m²</th><th>Precio/m²</th><th>Total €</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="totals">
        <div><div class="lbl">Total Proyecto</div><div class="val" id="projTotal">—</div></div>
      </div>
    </div>

    <div class="card">
      <h3>Exportar</h3>
      <div class="actions">
        <button id="pdfBtn" class="btn-icon-only" style="background:#e74c3c"><i class="fas fa-file-pdf" aria-hidden="true"></i> <span class="btn-label">PDF (Cliente)</span></button>
        <button id="excelBtn" class="btn-icon-only" style="background:#27ae60"><i class="fas fa-file-excel" aria-hidden="true"></i> <span class="btn-label">Excel (Control Interno)</span></button>
      </div>
      <div class="muted">
        <strong>PDF:</strong> Resumen para cliente (sistemas, materiales, rendimiento, precio/m², total)<br>
        <strong>Excel:</strong> Desglose completo para control interno
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const EUR = n => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(n||0);
    const LOGO_SVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgMjAwIiB3aWR0aD0iODAwIiBoZWlnaHQ9IjIwMCI+PHRleHQgeD0iMjAiIHk9IjExMCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjkwIiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSIjZTc0YzNjIj5BUklBUzwvdGV4dD48dGV4dCB4PSIyMCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzgiIGZvbnQtd2VpZ2h0PSIzMDAiIGZpbGw9IiMyYzNlNTAiPkdST1VQIENhcmliZSBTUkw8L3RleHQ+PC9zdmc+';

    // Schema adapter: compatibilidad v1/v2
    function normalizeSystemToV1(sys) {
      // Si ya tiene formato viejo (capas y placa string), devolverlo
      if (sys.capas !== undefined && sys.placa !== undefined && typeof sys.placa === 'string') {
        return sys;
      }
      
      // Convertir de nuevo schema (v2) a viejo (v1) para compatibilidad
      const placasStr = Array.isArray(sys.placas) && sys.placas.length > 0
        ? sys.placas.map(p => `${p.tipo}-${p.espesor_mm}`).join('+')
        : 'STD-13';
      
      return {
        id: sys.id,
        tipo: sys.tipo,
        perfil: sys._perfil_deprecated || (sys.perfil_mm ? `${sys.perfil_mm} ${sys.zincado || 'Z1'}` : '70 Z1'),
        modulacion_mm: sys.modulacion_mm || 600,
        placa: placasStr,
        capas: sys.capas_por_cara || sys.capas || 1,
        Hmax_m: sys.Hmax_m,
        csv: sys.csv,
        name: sys.nombre_comercial || sys.name || sys.id,
        // Mantener campos nuevos para funciones que los necesiten
        placas: sys.placas,
        capas_por_cara: sys.capas_por_cara,
        estructura: sys.estructura,
        perfil_mm: sys.perfil_mm,
        zincado: sys.zincado
      };
    }

    async function loadIndex(){
      const res = await fetch('sistemas/sistemas-index.json');
      const idx = await res.json();
      const systems = idx.systems || [];
      // Normalizar todos los sistemas al formato v1 para compatibilidad
      return systems.map(normalizeSystemToV1);
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().split(',');
      return lines.map(l=>{
        const cols = l.split(',');
        const obj = {};
        header.forEach((h,i)=> obj[h.trim()] = (cols[i]||'').trim());
        return obj;
      });
    }

    async function loadCSV(filename){
      const res = await fetch('sistemas/'+filename);
      if(!res.ok) throw new Error('No se pudo cargar '+filename);
      return await res.text();
    }

    function toNum(x){ return Number(String(x).replace(',','.'))||0; }

    let proyecto = [];

    async function calcularYMostrar(addToProject = false){
      const area = toNum(document.getElementById('area').value);
      const waste = toNum(document.getElementById('waste').value);
      const discount = toNum(document.getElementById('discount').value);
      const opt = document.getElementById('systemSelect').selectedOptions[0];
      if(!opt) return null;
      const meta = JSON.parse(opt.dataset.meta);

      document.getElementById('metaBox').innerHTML = `
        <div class="item"><strong>Sistema:</strong> ${meta.id}</div>
        <div class="item"><strong>Perfil:</strong> ${meta.perfil}</div>
        <div class="item"><strong>Placa:</strong> ${meta.placa}</div>
        <div class="item"><strong>Capas:</strong> ${meta.capas} por cara</div>
        <div class="item"><strong>Hmax:</strong> ${meta.Hmax_m} m</div>
      `;

      const csvText = await loadCSV(meta.csv);
      const rows = parseCSV(csvText);
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      let totalMat = 0;
      const rowsData = [];

      for(const r of rows){
        const precio = toNum(r.precio);
        const coef = toNum(r.coef);
        const qty = area * coef * (1 + waste/100);
        const imp = qty * precio;
        totalMat += imp;

        rowsData.push({...r, precio, coef, qty, imp});

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="num">${r.sku}</td>
          <td>${r.concepto}</td>
          <td class="num">${r.unidad}</td>
          <td class="num">${EUR(precio)}</td>
          <td class="num">${coef}</td>
          <td class="num">${qty.toFixed(3)}</td>
          <td class="num">${EUR(imp)}</td>
        `;
        tbody.appendChild(tr);
      }

      const totalConDescuento = totalMat * (1 - discount/100);

      const result = {
        system: meta.id,
        systemName: opt.textContent,
        area,
        waste,
        discount,
        total: totalConDescuento,
        totalSinDescuento: totalMat,
        rows: rowsData,
        meta
      };

      if(addToProject){
        proyecto.push(result);
        renderProyecto();
      }

      return result;
    }

    function renderProyecto(){
      const tbody = document.querySelector('#projTable tbody');
      tbody.innerHTML = '';
      let projTotal = 0;
      
      proyecto.forEach((p, idx)=>{
        projTotal += p.total;
        const precioPorM2 = p.total / p.area;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.system}</td>
          <td class="num">${p.area.toFixed(2)}</td>
          <td class="num">${EUR(precioPorM2)}</td>
          <td class="num">${EUR(p.total)}</td>
          <td>
            <button onclick="eliminarSistema(${idx})" class="btn-small" style="background:#e74c3c" aria-label="Eliminar sistema"><i class="fas fa-trash" aria-hidden="true"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('projTotal').textContent = EUR(projTotal);
    }

    window.eliminarSistema = function(idx){
      proyecto.splice(idx, 1);
      renderProyecto();
    }

    function svgToImageData(svgDataUri, callback) {
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
        const imageData = canvas.toDataURL('image/png', 1.0);
        callback(imageData);
      };
      img.onerror = function() {
        callback(null);
      };
      img.src = svgDataUri;
    }

    function getDescripcionComercial(meta) {
      const tipo = meta.tipo;
      const placa = meta.placa;
      const capas = meta.capas;
      const perfil = meta.perfil;
      
      let desc = '';
      
      if(tipo === 'MURO') {
        if(placa.includes('AQUA')) {
          desc = capas === 1 ? 'Tabique interior hidrófugo · Simple placa' : 'Tabique interior hidrófugo · Doble placa';
        } else if(placa.includes('MIX') || placa.includes('AQ-ST')) {
          desc = 'Tabique interior mixto (hidrófugo/estándar) · Doble placa';
        } else {
          desc = capas === 1 ? 'Tabique interior · Simple placa' : 'Tabique interior · Doble placa';
        }
        desc += ` · Perfilería ${perfil}`;
      } else if(tipo === 'TRASDOSADO') {
        if(meta.perfil.includes('Ω')) {
          desc = placa.includes('AQUA') 
            ? 'Trasdosado semidirecto hidrófugo · Perfil Ω35' 
            : 'Trasdosado semidirecto · Perfil Ω35';
        } else {
          if(placa.includes('AQUA')) {
            desc = capas === 1 ? 'Trasdosado autoportante hidrófugo · Simple placa' : 'Trasdosado autoportante hidrófugo · Doble placa';
          } else {
            desc = capas === 1 ? 'Trasdosado autoportante · Simple placa' : 'Trasdosado autoportante · Doble placa';
          }
          desc += ` · Perfilería ${perfil}`;
        }
      } else if(tipo === 'TECHO') {
        if(placa.includes('AQUA')) {
          desc = `Techo continuo hidrófugo · Perfil ${perfil}`;
        } else {
          desc = `Techo continuo · Perfil ${perfil}`;
        }
        desc += ' · Simple placa';
      } else if(tipo === 'EXTERIOR') {
        desc = `Fachada ventilada · Perfilería ${perfil} · Placa externa`;
      }
      
      return desc || 'Sistema constructivo FassaBortolo';
    }

    async function exportPDF(){
      if(proyecto.length === 0){
        alert('No hay sistemas en el proyecto');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
      const date = new Date().toLocaleDateString('es-ES');
      const projectName = document.getElementById('projectName').value || 'Proyecto';
      const total = proyecto.reduce((t,p)=>t+p.total,0);

      return new Promise((resolve) => {
        svgToImageData(LOGO_SVG, (logoData) => {
          if(logoData) {
            doc.addImage(logoData, 'PNG', 14, 10, 60, 15);
          }
          
          doc.setFontSize(20);
          doc.setTextColor('#e74c3c');
          doc.text('Presupuesto', 14, logoData ? 28 : 22);
          doc.setFontSize(11);
          doc.setTextColor('#666');
          doc.text(`Proyecto: ${projectName}`, 14, logoData ? 34 : 32);
          doc.text(`Fecha: ${date}`, 14, logoData ? 40 : 38);

          let y = logoData ? 52 : 48;

          proyecto.forEach((p, idx) => {
            if(y > 250) {
              doc.addPage();
              y = 20;
            }

            const precioPorM2 = p.total / p.area;
            const systemName = p.meta?.name || p.system;
            const descripcion = getDescripcionComercial(p.meta || {});
            
            // Línea separadora
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.5);
            doc.line(14, y, 196, y);
            y += 8;
            
            // Nombre del sistema
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#2c3e50');
            doc.text(systemName, 14, y);
            y += 7;
            
            // Descripción comercial
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor('#555');
            const descLines = doc.splitTextToSize(descripcion, 180);
            doc.text(descLines, 14, y);
            y += descLines.length * 4 + 4;
            
            // Información del sistema
            doc.setFontSize(10);
            doc.setTextColor('#666');
            doc.text(`Superficie: ${p.area.toFixed(2)} m²`, 14, y);
            doc.text(`Precio unitario: ${EUR(precioPorM2)}/m²`, 110, y);
            y += 8;
            
            // Total del sistema (destacado)
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#2c3e50');
            doc.text(`IMPORTE TOTAL SISTEMA: ${EUR(p.total)}`, 14, y);
            y += 15;
          });

          // Línea separadora final
          doc.setDrawColor(220, 220, 220);
          doc.setLineWidth(1);
          doc.line(14, y, 196, y);
          y += 10;
          
          // Total proyecto (muy destacado)
          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.setTextColor('#e74c3c');
          doc.text(`TOTAL PROYECTO: ${EUR(total)}`, 14, y);
          
          // Nota final
          y += 10;
          doc.setFontSize(8);
          doc.setFont(undefined, 'normal');
          doc.setTextColor('#999');
          doc.text('Presupuesto elaborado según sistemas FassaBortolo. Desglose técnico disponible bajo consulta.', 14, y);

          doc.save(`Presupuesto_${projectName.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}.pdf`);
          resolve();
        });
      });
    }

    function exportExcel(){
      if(proyecto.length === 0){
        alert('No hay sistemas en el proyecto');
        return;
      }

      const wb = XLSX.utils.book_new();
      const date = new Date().toLocaleDateString('es-ES');
      const projectName = document.getElementById('projectName').value || 'Proyecto';

      const wsResumen = XLSX.utils.aoa_to_sheet([
        ['PROYECTO:', projectName],
        ['FECHA:', date],
        [''],
        ['Sistema','m²','Precio/m²','Total €'],
        ...proyecto.map(p => [
          p.system,
          p.area.toFixed(2),
          (p.total / p.area).toFixed(2),
          p.total
        ]),
        [''],
        ['TOTAL PROYECTO', '', '', proyecto.reduce((t,p)=>t+p.total,0)]
      ]);
      XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');

      proyecto.forEach(p => {
        const ws = XLSX.utils.aoa_to_sheet([
          ['SISTEMA:', p.system],
          ['m²:', p.area],
          ['Desperdicio:', p.waste + '%'],
          ['Descuento:', p.discount + '%'],
          [''],
          ['SKU','Concepto','Unidad','Precio','Coef','Cantidad','Importe'],
          ...p.rows.map(r => [
            r.sku,
            r.concepto,
            r.unidad,
            r.precio,
            r.coef,
            r.qty.toFixed(3),
            r.imp
          ]),
          [''],
          ['TOTAL SISTEMA', '', '', '', '', '', p.total]
        ]);
        XLSX.utils.book_append_sheet(wb, ws, p.system.slice(0,31));
      });

      XLSX.writeFile(wb, `Proyecto_${projectName.replace(/\s+/g,'_')}_${date.replace(/\//g,'-')}.xlsx`);
    }

    (async()=>{
      const systems = await loadIndex();
      const tipoOrder = {'MURO':1,'TRASDOSADO':2,'TECHO':3,'EXTERIOR':4};
      const sorted = systems.sort((a,b)=>{
        const orderA = tipoOrder[a.tipo] || 99;
        const orderB = tipoOrder[b.tipo] || 99;
        return orderA - orderB;
      });
      const sel = document.getElementById('systemSelect');
      sorted.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.csv;
        opt.textContent = s.name || `${s.id} | ${s.tipo} | ${s.perfil} | ${s.placa} | ${s.capas} capa(s)/cara`;
        opt.dataset.meta = JSON.stringify(s);
        sel.appendChild(opt);
      });

      sel.addEventListener('change', async()=>{
        await calcularYMostrar(false);
      });

      document.getElementById('addBtn').addEventListener('click', async()=>{
        await calcularYMostrar(true);
      });

      document.getElementById('pdfBtn').addEventListener('click', exportPDF);
      document.getElementById('excelBtn').addEventListener('click', exportExcel);
      renderProyecto();
    })();
  </script>
</body>
</html>
